![[Pasted image 20250806145014.png]]
## 需求背景

算法侧货量预估能力有所提升，提供了更为准确的货量预估能力。基于算法侧提供的新的货量预估接口，同时考虑到稳定性，提供灰度开关，为部分仓先开放新接口，测试是否会对排线造成影响、以及排线能力是否有所提升。

## 技术方案

### 新增配置

添加两个灰度配置，一个用于**判断是否全量开启新算法接口切换**；一个用于**根据不同仓判断是否调用新的算法侧接口**。

灰度开关存储需要启用新货量预估接口的仓ID，代码侧通过判断配置中是否有对应仓ID来选择是否使用新接口。

```
/**
 * 是否全量切换新货量预估接口的开关
 */
@MtConfig(clientId = TscConstants.APP_KEY, key = "new_estimate_quantity_query_outbound_switch")
public static boolean newEstimateQuantityQueryOutboundSwitch = false; // 配置是否需要全量开启接口切换

/**
 * 切换新货量预估接口的仓库ID列表
 */
@MtConfig(clientId = TscConstants.APP_KEY, key = "new_estimate_quantity_query_outbound_list")
public static String newEstimateQuantityQueryOutboundList = "[]"; // 配置需要启用新算法接口的仓ID
```

配置应具备的功能：
1. 用于快速关闭新接口切换；
    - **为什么需要？**
        用于在发布后新接口出问题后能快速回退？
        那为什么不直接回滚到上一个稳定版本呢？
        采用灰度开关更快？**配置变更时间需要多久？**
2. 用于配置需要开启新接口的仓库ID列表；
3. 用于打开/关闭接口切换的全量开关。
### 存储设计
不涉及表的新增，复用原表`tsc-estimate_transport_quantity`，用于存储预估货量数据。

### 定时任务
复用原有定时任务。
`@Crane("tsc.pre.estimate.quantity.calculate")`：每天19:00执行一次。
`@Crane("tsc.pre.automation.route.query.estimate.quantity")`：每30秒执行一次。

### 流程设计
两个货量预估方法最后的预估货量逻辑都会走到`com.sankuai.mall.logistics.tsc.crane.estimate.RdcPreEstimateQuantityTask#calPreEstimateQuantityByRdc÷`方法中。并且方法传参中带有发货地信息`outBoundDTO`，因此我们在这里添加判断，判断发货地是否在灰度配置中，如果在灰度配置中就调用新的算法侧接口：
![[Pasted image 20250806145134.png]]
![[Pasted image 20250806145215.png]]
## 疑问

1. ##### RdcPreEstimateQuantityTask中的货量预估任务和PreEstimateQuantityTask中的货量预估任务有什么区别？两个方法都需要改造吗？
    
    - 前者是查询19:00时的算法侧货量预估数据；后者是每30秒执行一次，查询当前时间内最早的货量预估数据。
        
    - 前者获取的配置信息是「仓+配」；后者获取的配置是「运输组」，并根据运输组获取所有仓，并进一步by仓获取所有预估货量。
        
        - 运输业务中，一个运输组管理多个仓。
            
2. ##### 算法侧提供的新接口是什么？
    
    - rdcPoiQuantityTnBatchForecast
        
3. ##### by仓、by门店、by波次聚合数据指的是？
    
    - 也就是将数据整合为`estimate_transport_quantity`表中的数据。
        
4. ##### 为什么表要新加三个字段？![image.png](https://km.sankuai.com/api/file/cdn/2712756225/167616206063?contentType=1&isNewContent=false)
    
    - 还是采用原表，不进行任何改动。
        
5. ##### 为什么配置中是配置运输组ID，而不是收货地(门店)ID？
    
    - 预估货量就是预估的仓-所有门店的货量，因此无需配置门店ID。
        
    
    - 实质上在调用算法接口时还是根据「**门店-仓库-时间**」这三个维度来预估货量的。
        
6. ##### 上次说的只查“19:00”/“~~第一版~~”的数据是什么意思？再明确一下测试逻辑。
    
    - 算法侧会在每天定时预估几版数据并落库，在19:00之后查的数据预估准确率更高。
        
    
    - 调用预估货量接口时需要传入时间，也就是说我们只在19:00时(之后)调用货量预估接口？
        
7. ##### 基于历史数据测试指的是？
    

- 基于doQueryEstimateQuantity()做运维接口，使用当天之前的数据进行测试，生成约车单。
    
    - （T-1货量预估，基于当天之前生成的约车单不会影响线上数据。）