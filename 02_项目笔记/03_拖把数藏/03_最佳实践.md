## 1. Facadeå±‚çš„å¼•å…¥
é—¨é¢å±‚éš”ç¦»å‰å°å’Œåå°ç³»ç»Ÿï¼Œå®šä¹‰ç‰¹å®šäº**ç”¨æˆ·æ¥å£å±‚çš„æ•°æ®ç»“æ„ï¼Œä»åå°è·å–æ•°æ®å†…å®¹å¹¶è½¬åŒ–ä¸ºç”¨æˆ·æ¥å£å±‚çš„æ•°æ®å½¢å¼**ã€‚

Facadeå±‚ä¸»è¦åŒ…å«**å¯¹å¤–æä¾›çš„RPCæœåŠ¡**ã€‚

## 2. åŸºäºSaTokençš„ç»Ÿä¸€é‰´æƒè®¾è®¡
- ç”¨æˆ·æœ‰ä¸‰ç§è§’è‰²ï¼šç®¡ç†å‘˜ADMINã€æ™®é€šç”¨æˆ·CUSTOMERã€è‰ºæœ¯å®¶ARTISTã€‚
- ç”¨æˆ·çŠ¶æ€æœ‰ä¸ƒç§ï¼šFREEZEå†»ç»“ã€UNFREEZEè§£å†»ã€LOGINç™»å½•ã€REGISTERæ³¨å†Œã€æ¿€æ´»ACTIVEã€å®åè®¤è¯AUTHã€ä¿®æ”¹ä¿¡æ¯NOTIFYã€‚
- ç”¨æˆ·æƒé™æœ‰å››ç§ï¼šåŸºæœ¬æƒé™BASICã€å·²å®åè®¤è¯æƒé™AUTHã€å·²å†»ç»“æƒé™FROZENã€æ— ä»»ä½•æƒé™NONEã€‚

ä¸åŒçŠ¶æ€ã€è§’è‰²çš„ç”¨æˆ·çš„æƒé™ä¸åŒï¼š
1. **æœªç™»å½•**ï¼š
	- å¯æŸ¥çœ‹å•†å“ã€‚
2. **å·²ç™»å½•æœªå®å**ï¼š  
	- å¯æŸ¥çœ‹å•†å“ï¼›
	- å¯æŸ¥çœ‹ä¸ªäººä¿¡æ¯ï¼›
3.  **å·²å®å**ï¼š
	- åœ¨æœªå®ååŠŸèƒ½çš„åŸºç¡€ä¸Šæ–°å¢ã€Œä¸‹å•åŠŸèƒ½ã€ã€‚
- **ç®¡ç†ç«¯**ï¼š
	- ç®¡ç†å•†å“ã€‚
- **è¢«å†»ç»“**ï¼š
	- æ— æ³•ä¸‹å•ã€‚

#### å¦‚ä½•è·å–ç”¨æˆ·çš„æƒé™å’Œè§’è‰²å‘¢ï¼Ÿ
SaTokené›†æˆç½‘å…³æ•™ç¨‹ï¼š[satoken+ gatewayç½‘å…³ç»Ÿä¸€é‰´æƒ åˆç‰ˆ_satoken gateway-CSDNåšå®¢](https://blog.csdn.net/huangchong0107/article/details/130185402)
SaTokené‰´æƒå¦‚ä½•å®ç°ï¼Œå®˜æ–¹ï¼š[æƒé™è®¤è¯](https://sa-token.cc/doc.html#/use/jur-auth)

é€šè¿‡SaTokenå’ŒOAuth2å®ç°ã€‚

>[!abstract] OAuthæ˜¯ä»€ä¹ˆï¼Ÿ
 ç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ª**çŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨**ã€‚å…³é”®ç‚¹åœ¨äºä»¤ç‰Œæ˜¯ä¼šè‡ªåŠ¨è¿‡æœŸçš„ï¼

é…ç½®SaTokenConfigï¼š
- å…¶ä¸­`getSaReactorFilter`ç”¨äºæ³¨å†ŒSaTokenå…¨å±€è¿‡æ»¤å™¨ï¼Œå®šä¹‰æ‰€éœ€æ‹¦æˆªã€æ”¾è¡Œçš„åœ°å€ï¼Œè¿›è¡Œæƒé™æ ¡éªŒã€‚
- `getSaResult`ç”¨äºå®šä¹‰å‡ºç°è¶Šæƒåè¿”å›çš„ä¿¡æ¯ã€‚

#### å…·ä½“ä¸šåŠ¡é€»è¾‘
- ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œå¯ä»¥è®¿é—®ç½‘ç«™ï¼ŒæŸ¥çœ‹å•†å“åˆ—è¡¨ä»¥åŠå•†å“è¯¦æƒ…ã€‚åŒæ—¶ï¼Œå¼€æ”¾`/login`ã€`/register`ç«¯å£ç”¨äºæ³¨å†Œã€ç™»å½•ã€‚
- ç”¨æˆ·ç™»å½•åï¼Œä¼šå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°Sessionä¸­ã€`AuthController`ã€‘ï¼Œåç»­é‰´æƒå¯ä»¥ä»Sessionä¸­è·å–ç”¨æˆ·è§’è‰²ã€çŠ¶æ€æ¥è®¾ç½®æƒé™ï¼›
- åç»­ç”¨æˆ·æ¯æ¬¡è®¿é—®æŸä¸ªé¡µé¢ï¼Œéƒ½ä¼šè¢«SaTokençš„è¿‡æ»¤å™¨æ•è·ï¼Œå¹¶é€šè¿‡Sessionä¸­çš„è§’è‰²å’ŒçŠ¶æ€æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨è¯¥æƒé™ã€‚

## 3. åŸºäºSaTokenå®ç°çš„å•ç‚¹ç™»å½•ï¼ˆç»Ÿä¸€è®¤è¯ï¼‰ï¼ˆåˆ†å¸ƒå¼Sessionï¼‰
- ç”¨æˆ·è®¿é—®åˆ°æŸä¸ªé¡µé¢æ—¶ï¼Œè‹¥å‘ç°æœªç™»å½•ï¼Œåˆ™ä¼šè¢«è·¯ç”±åˆ°ç™»å½•é¡µé¢ï¼›æˆ–ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢ã€‚
- ç”¨æˆ·ç™»å½•ï¼Œè¾“å…¥æ‰‹æœºå·ã€éªŒè¯ç è¿›è¡Œç™»å½•ï¼Œä¼šé€šè¿‡æ‰‹æœºå·åœ¨Redisä¸­æŸ¥è¯¢éªŒè¯ç å¹¶åˆ¤æ–­æ˜¯å¦æ­£ç¡®ï¼Œé”™è¯¯åˆ™ç›´æ¥è¿”å›ï¼›
- è‹¥éªŒè¯ç æ­£ç¡®ï¼Œä¼šé€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œï¼Œè‹¥æœªæ³¨å†Œï¼Œåˆ™ä¼šå¸®åŠ©ç”¨æˆ·æ³¨å†Œï¼›
- è‹¥å·²æ³¨å†Œæˆ–æœªæ³¨å†Œè¢«æ³¨å†Œå®Œæ¯•ï¼Œåˆ™ä¼šè¿›è¡Œç™»å½•æ“ä½œï¼šå³â‘ æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ›å»ºSaTokenï¼Œå¹¶å°†tokenä½œä¸ºKeyï¼Œç”¨æˆ·Idä½œä¸ºValueå­˜å‚¨åˆ°Redisï¼Œå¹¶éšcookieè¿”å›ç»™å‰ç«¯ï¼›åŒæ—¶ï¼Œä¼šåˆ›å»ºSessionä¿å­˜ç”¨æˆ·ä¿¡æ¯ã€‚

> é™„åŠ ï¼šæ­¤å¤„è¿˜åˆ›å»ºäº†ä¸€ä¸ªSessionï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°äº†Sessionä¸­ï¼ŒåŒæ—¶Sessionä¿å­˜åˆ°Redisä¸­ï¼Œä¾¿äºåç»­ç»Ÿä¸€é‰´æƒæ—¶èƒ½ä»Sessionä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯å¹¶è·å–ç”¨æˆ·æƒé™ã€‚
```java
//ç™»å½•
StpUtil.login(userInfo.getUserId(), new SaLoginModel().setIsLastingCookie(loginParam.getRememberMe())
		.setTimeout(DEFAULT_LOGIN_SESSION_TIMEOUT));
// åœ¨Redisä¸­ä¿å­˜äº†ä¼šè¯ï¼Œä¼šè¯ä¸­è®°å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆKEYä¸ºç”¨æˆ·IDï¼ŒVALUEä¸ºç”¨æˆ·ä¿¡æ¯ï¼‰
StpUtil.getSession().set(userInfo.getUserId().toString(), userInfo);
LoginVO loginVO = new LoginVO(userInfo);
return Result.success(loginVO);
```

**æ€»ç»“ä¸€ä¸‹**ï¼š
1. ç”¨æˆ·ç™»å½•æ—¶ä¼šåˆ›å»ºSaTokenï¼Œå¹¶å°†SaTokenä½œä¸ºKEYï¼Œç”¨æˆ·IDä½œä¸ºVALUEï¼Œä¿å­˜åˆ°Redisä¸­ï¼›
2. SaTokenåˆ›å»ºå®Œæ¯•åï¼Œè¿˜ä¼šä¿å­˜åˆ°cookieä¸­è¿”å›ç»™å‰ç«¯ã€‚åç»­å‰ç«¯å‘é€è¯·æ±‚éƒ½æºå¸¦è¯¥Cookieï¼›
3. åç»­åœ¨ä¸‹å•ç­‰åŠŸèƒ½æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨`StpUtil.getLoginId()`æ¥æ ¡éªŒæ˜¯å¦ç™»é™†ã€‚
	- æ ¡éªŒé€»è¾‘ï¼šå–å‡ºcookieæºå¸¦çš„satokenï¼Œç„¶åæ ¹æ®tokençš„å€¼å–Redisä¸­å–å‡ºloginIdï¼Œè‹¥loginIdç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¯´æ˜ç”¨æˆ·å·²ç™»å½•ï¼Œè¿”å›loginIDã€‚
## 4. åŸºäºRedissonæ»‘åŠ¨çª—å£å®ç°éªŒè¯ç å‘é€é™æµ
åŸºäºRedissonçš„ä»¤ç‰Œæ¡¶ï¼Œä½†æ˜¯å°†ä»¤ç‰Œæ¡¶çš„è¯·æ±‚æ•°è®¾ç½®ä¸º1æ—¶ï¼Œæ­¤æ—¶ä»¤ç‰Œæ¡¶å°±é€€åŒ–æˆæ»‘åŠ¨çª—å£ã€‚

## 5. è‡ªå®šä¹‰ TypeHandler å®ç°éšç§æ•°æ®è‡ªåŠ¨åŠ è§£å¯† 
#### åŸºæœ¬ä»‹ç»
ä½¿ç”¨MyBatisçš„TypeHandlerå®ç°éšç§æ•°æ®çš„è‡ªåŠ¨åŠ è§£å¯†ã€‚TypeHandler ä½œç”¨æ˜¯åœ¨MyBatis æ‰§è¡Œæ•°æ®æŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œæ—¶ï¼Œå°†**æ•°æ®åº“ä¸­çš„åˆ—å€¼è½¬æ¢ä¸ºJava å¯¹è±¡ï¼Œå¹¶åœ¨å°†Java å¯¹è±¡å†™å…¥æ•°æ®åº“æ—¶æ‰§è¡Œç›¸åçš„è½¬æ¢**ã€‚

#### å®ç°æ­¥éª¤
- ç»§æ‰¿BaseTypeHandlerç±»ï¼Œå®ç°è‡ªå®šä¹‰åŠ è§£å¯†TypeHandlerï¼Œå®ç°å…¶ä¸­çš„å››ä¸ªæŠ½è±¡æ–¹æ³•ï¼š
	- å•Š
- 
## 6. åŸºäºZSetå®ç°æ’è¡Œæ¦œåŠŸèƒ½
### ğŸ”éœ€æ±‚åˆ†æ
- è·å–ç”¨æˆ·çš„é‚€è¯·æ’åï¼šæ ¹æ®ç”¨æˆ·ç§¯åˆ†ä»é«˜åˆ°ä½è¿›è¡Œæ’åºã€‚å¤§æ¦‚å±•ç¤ºä¸ºï¼š`ç”¨æˆ·ID-æ’å-ç§¯åˆ†`
- è·å–æˆ‘çš„æ’åï¼šç”¨æˆ·èƒ½æŸ¥çœ‹è‡ªå·±åœ¨æ’è¡Œæ¦œä¸­çš„æ’åã€‚
### ğŸ’¾å­˜å‚¨è®¾è®¡
- åŸºäºéœ€æ±‚åˆ†æï¼Œé‡‡ç”¨ZSetè¿›è¡Œå­˜å‚¨ï¼Œèƒ½æ ¹æ®ZSetçš„å¯¹åº”æ–¹æ³•å®ç°ä¸Šè¿°åŠŸèƒ½ã€‚
- KEYä¸ºinviteRankï¼ŒMemberä¸ºç”¨æˆ·IDï¼ŒScoreä¸ºç§¯åˆ†ï¼ŒZSetä¼šé»˜è®¤æŒ‰ç…§ç§¯åˆ†è¿›è¡Œå‡åºæ’åˆ—ã€‚
### ğŸ”Œæ¥å£è®¾è®¡
#### 1. è·å–æ’è¡Œæ¦œ
- ä½¿ç”¨`ZREVRANGEBYSCORE`æ–¹æ³•è·å–æŒ‰ç…§åˆ†æ•°ç”±é«˜åˆ°ä½çš„æ’åã€‚
```java
//æŒ‰ç…§åˆ†æ•°ä»é«˜åˆ°ä½ï¼Œè·å–å‰Nä¸ªç”¨æˆ·çš„æ’åä¿¡æ¯
public List<InviteRankInfo> getTopN(Integer topN) {
	// ä¼ å…¥èµ·ç‚¹ä¸ç»ˆç‚¹ï¼Œè·å–å‰Nä¸ªç”¨æˆ·çš„æ’åã€‚
    Collection<ScoredEntry<String>> rankInfos = inviteRank.entryRangeReversed(0, topN - 1);

    List<InviteRankInfo> inviteRankInfos = new ArrayList<>();

    if (rankInfos != null) {
        for (ScoredEntry<String> rankInfo : rankInfos) {
            InviteRankInfo inviteRankInfo = new InviteRankInfo();
            // æ ¹æ®Memberè·å–ç”¨æˆ·ID
            String userId = rankInfo.getValue();
            // æ ¹æ®MemberæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç”¨äºè¿”å›å‰ç«¯å±•ç¤º
            if (StringUtils.isNotBlank(userId)) {
                User user = findById(Long.valueOf(userId));
                if (user != null) {
	                // æ˜µç§°
                    inviteRankInfo.setNickName(user.getNickName());
                    // é‚€è¯·ç 
                    inviteRankInfo.setInviteCode(user.getInviteCode());
                    // é‚€è¯·äººæ•°ï¼Œå› ä¸ºé‚€è¯·ä¸€ä¸ªäººåˆ†æ•°+100.
                    inviteRankInfo.setInviteCount(rankInfo.getScore().intValue() / 100);
                    // è¿”å›topNç”¨æˆ·ä¿¡æ¯é›†åˆç»™å‰ç«¯
                    inviteRankInfos.add(inviteRankInfo);
                }
            }
        }
    }

    return inviteRankInfos;
}
```
#### 2. è·å–æˆ‘çš„æ’å
- ä½¿ç”¨`ZREVRANK`æ–¹æ³•å®ç°æŒ‰ç…§åˆ†æ•°ç”±é«˜åˆ°ä½æ’åºæ—¶ï¼Œæˆå‘˜Memberçš„æ’åã€‚
```java
//è·å–æŒ‡å®šç”¨æˆ·çš„æ’åï¼ŒæŒ‰ç…§åˆ†æ•°ä»é«˜åˆ°ä½
public Integer getInviteRank(String userId) {
    Integer rank = inviteRank.revRank(userId);
    if (rank != null) {
	    // å› æ­¤ä»¥0ä½œä¸ºèµ·ç‚¹ï¼Œæ‰€ä»¥éœ€è¦+1
        return rank + 1;
    }
    return null;
}
```
#### 3. æ›´æ–°æ’å
- ç”¨æˆ·åœ¨æ³¨å†Œæ—¶è‹¥å¡«å†™äº†é‚€è¯·ç ï¼Œåˆ™ä¼šå¢åŠ å¯¹åº”é‚€è¯·ç çš„ç§¯åˆ†ã€‚å¯¹åº”ä½¿ç”¨ZINCRBYå‘½ä»¤å®ç°ã€‚
- ä¸ºäº†é¿å…å¹¶å‘é—®é¢˜ï¼Œä½¿ç”¨Redissonå¯¹é‚€è¯·äººIDåŠ é”ã€‚å› ä¸ºé“¾è·¯è¾ƒçŸ­ï¼Œæ‰§è¡Œè¾ƒå¿«ï¼Œå› æ­¤åŠ é”è€Œä¸ç”¨Luaè„šæœ¬ï¼Œä¹Ÿä¸ä¼šå¤ªå½±å“ç”¨æˆ·ä½“éªŒã€‚
```java
private void updateInviteRank(String inviterId) {
    // å¦‚æœé‚€è¯·è€…IDä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œæ“ä½œ
    if (inviterId == null) {
        return;
    }

    // è·å–Redissonçš„é”å¯¹è±¡
    RLock rLock = redissonClient.getLock(inviterId);
    // å¯¹é‚€è¯·è€…IDå¯¹åº”çš„é”è¿›è¡ŒåŠ é”æ“ä½œï¼Œé¿å…å¹¶å‘æ›´æ–°
    rLock.lock();
    try {
        // è·å–é‚€è¯·è€…çš„å½“å‰æ’ååˆ†æ•°
        Double score = inviteRank.getScore(inviterId);
        // å¦‚æœå½“å‰åˆ†æ•°ä¸ºç©ºï¼Œåˆ™è®¾ç½®é»˜è®¤ä¸º0.0
        if (score == null) {
            score = 0.0;
        }
        // å°†é‚€è¯·è€…çš„æ’ååˆ†æ•°å¢åŠ 100.0ï¼Œå¹¶æ›´æ–°åˆ°æ’è¡Œæ¦œä¸­
        inviteRank.add(score + 100.0, inviterId);
    } finally {
        // æœ€ç»ˆé‡Šæ”¾é‚€è¯·è€…IDå¯¹åº”çš„é”
        rLock.unlock();
    }
}
```
### ğŸ™‹ğŸ»â€â™‚ï¸é—®é¢˜åˆ†æ
#### ä½¿ç”¨ZSetå­˜å‚¨ï¼Œæ²¡æœ‰æŒä¹…åŒ–å’‹åŠï¼Ÿ
- ä¸€æ˜¯æ’è¡Œæ¦œæ•°æ®ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œå› æ­¤æ— éœ€ä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–ï¼Œå¯ä»¥ä½¿ç”¨RedisæŒä¹…åŒ–å®ç°ï¼›
- äºŒæ˜¯è‹¥Rediså®•æœºæ•°æ®ä¸¢å¤±äº†ï¼Œå¯ä»¥å®šæ—¶åˆ°æ•°æ®åº“æŸ¥ä¸€æ¬¡ï¼Œåˆ©ç”¨`where invite_id = #{id}`å°±å¯ä»¥æŸ¥è¯¢å‡ºè¯¥ç”¨æˆ·çš„é‚€è¯·äººæ•°ã€‚
- å¯¹äºæ›´æ–°ä¸é¢‘ç¹çš„æ’è¡Œæ¦œæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨RDBæŒä¹…åŒ–ã€‚å°†saveé…ç½®å‚æ•°è®¾ç½®ä¸ºé€‚å½“çš„å€¼ï¼Œä»¥å¹³è¡¡æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ï¼›åŒæ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡ŒBGSAVEæˆ–SAVEå‘½ä»¤æ¥åˆ›å»ºæ•°æ®é›†å¿«ç…§ã€‚
- å¯¹äºæ›´æ–°é¢‘ç¹çš„æ’è¡Œæ¦œæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨AOFæŒä¹…åŒ–ï¼Œå¹¶è®¾ç½®`appendfsync`å‚æ•°æ¥æ§åˆ¶AOFæ–‡ä»¶çš„åŒæ­¥é¢‘ç‡ã€‚

## 7. åŸºäºElasticSearchå®ç°è—å“æœç´¢ TODO

ä½¿ç”¨ESæ—¶ï¼Œå¾€å¾€éƒ½æ˜¯åŸºäºä¸¤ä¸ªç›®çš„ï¼š
4. ä½¿ç”¨æœç´¢åŠŸèƒ½ï¼Œéœ€è¦å€’æ’ç´¢å¼•ï¼›
5. ä½¿ç”¨å®½è¡¨ï¼Œéœ€è¦å¤šè¡¨Join
### æ·±åˆ†é¡µä¼˜åŒ–
### ESå’ŒDBçš„åŠ¨æ€åˆ‡æ¢
- é¦–å…ˆæ˜¯CollectionServiceçš„æ¥å£ï¼Œåœ¨Beanå£°æ˜æ—¶ä½¿ç”¨æ¥å£è¿›è¡Œå£°æ˜ï¼›
- åœ¨å®ç°ç±»ä¸­ï¼Œå®šä¹‰CollectionEsServiceå’ŒCollectionDbServiceä¸¤ä¸ªå®ç°ç±»ï¼Œæ­¤æ—¶Beanå£°æ˜åº”è¯¥ä¼šæŠ¥é”™ï¼Œå› ä¸ºSpringæ¡†æ¶ä¸çŸ¥é“å…·ä½“è¦æ³¨å…¥å“ªä¸ªBeanï¼›
- åœ¨CollectionDbServiceä¸­æ·»åŠ æ³¨è§£`@ConditionalOnProperty()`ï¼Œæ­¤æ—¶åœ¨é…ç½®æ–‡ä»¶å®ç°å¯¹åº”é…ç½®ï¼Œå°±å¯ä»¥å®ç°åŠ¨æ€åˆ‡æ¢ã€‚

```java
@Service  
@ConditionalOnProperty(name = "spring.elasticsearch.enable", havingValue = "false", matchIfMissing = true)  
public class CollectionDbService extends BaseCollectionService {
	...
}
```
```yml
[es.yml]
spring:
  elasticsearch:
    enable: ${nft.turbo.elasticsearch.enable}
    uris: http://${nft.turbo.elasticsearch.url}
    username: ${nft.turbo.elasticsearch.username}
    password: ${nft.turbo.elasticsearch.password}
```
## 8. åŸºäºXXL-JOBå®ç°åŒºå—é“¾æ¨¡å—å¼‚æ­¥æ“ä½œçš„åå¤„ç†


## 9. åŸºäºTokenæ ¡éªŒé¿å…è®¢å•é‡å¤æäº¤
 ç”¨æˆ·ç™»å½•æ—¶ï¼Œæ„é€ tokenè¿”å›ç»™å‰ç«¯ï¼Œå¹¶ä¸”å­˜å‚¨åœ¨Redisä¸­ã€‚åç»­è¯·æ±‚ï¼Œä½¿ç”¨tokenFilterç±»å®ç°å¯¹ç”¨æˆ·ä¸‹å•çš„è¯·æ±‚è¿›è¡Œtokençš„æ ¡éªŒã€‚

```java
@AutoConfiguration  
@ConditionalOnWebApplication  
public class WebConfiguration implements WebMvcConfigurer {  
  
    @Bean  
    @ConditionalOnMissingBean    GlobalWebExceptionHandler globalWebExceptionHandler() {  
        return new GlobalWebExceptionHandler();  
    }  
  
    /**  
     * æ³¨å†Œtokenè¿‡æ»¤å™¨  
     *  
     * @param redissonClient  
     * @return  
     */  
    @Bean  
    public FilterRegistrationBean<TokenFilter> tokenFilter(RedissonClient redissonClient) {  
        FilterRegistrationBean<TokenFilter> registrationBean = new FilterRegistrationBean<>();  
  
        registrationBean.setFilter(new TokenFilter(redissonClient));  
        registrationBean.addUrlPatterns("/trade/buy","/trade/newBuy");  
        registrationBean.setOrder(10);  
  
        return registrationBean;  
    }  
  
}
```

doFilteræ–¹æ³•ï¼šå®ç°å…·ä½“çš„æ ¡éªŒtokençš„é€»è¾‘ã€‚
- ä»è¯·æ±‚å¤´ä¸­è·å–tokenï¼Œæ ¡éªŒtokenæ˜¯å¦ä¸ºç©ºã€æœ‰æ•ˆæ€§ï¼ˆä½¿ç”¨Luaè„šæœ¬è¿›è¡Œåˆ¤æ–­ï¼‰ï¼›
	- ä½¿ç”¨Luaè„šæœ¬ï¼Œå–å‡ºTokenç„¶åDELæ‰ã€‚ï¼ˆåˆ æ‰å°±ä¿è¯åªèƒ½ä½¿ç”¨ä¸€æ¬¡äº†ï¼ï¼‰
- è‹¥tokenæ ¡éªŒé€šè¿‡ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå…¶å®ƒè¿‡æ»¤å™¨ã€‚ï¼ˆè¿‡æ»¤å™¨é“¾ï¼‰ã€æœ¬é¡¹ç›®ä¸­åªä½¿ç”¨äº†TokenFilterä¸€ä¸ªè¿‡æ»¤å™¨ã€‚ã€‘

è¿™é‡Œè¿˜é¢å¤–å°†tokenå­˜å…¥ThreadLocalä¸­ï¼Œå¯ä»¥åœ¨æ•°æ®åº“çš„è®¢å•è¡¨ä¸­ä½¿ç”¨å¹‚ç­‰å·ï¼Œç”¨äº**åº“å­˜çš„é¢„æ‰£å‡å’Œä¸‹å•è¿‡ç¨‹ä¸­çš„å¯¹è´¦**ã€‚æ­¤æ—¶åº“å­˜é¢„æ‰£å‡æ—¶ï¼Œè®¢å•å·è¿˜æ²¡ç”Ÿæˆï¼Œå› æ­¤æ— æ³•ä½¿ç”¨è®¢å•å·è¿›è¡Œå¹‚ç­‰æ§åˆ¶ã€‚
- å¹‚ç­‰å·åœ¨è®¢å•çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦æ¶‰åŠåˆ°è¿œç¨‹è°ƒç”¨ï¼Œé‚£ä¹ˆå°±å°†å¹‚ç­‰å·å–å‡ºæ¥æ”¾åœ¨Requestä¸­ä¼ é€’å°±å¯ä»¥ã€‚
```java
@Override  
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {  
    try {  
        HttpServletRequest httpRequest = (HttpServletRequest) request;  
        HttpServletResponse httpResponse = (HttpServletResponse) response;  
  
        // ä»è¯·æ±‚å¤´ä¸­è·å–Token  
        String token = httpRequest.getHeader("Authorization");  
  
        if (token == null || "null".equals(token) || "undefined".equals(token)) {  
            httpResponse.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  
            httpResponse.getWriter().write("No Token Found ...");  
            logger.error("no token found in header , pls check!");  
            return;  
        }  
  
        // æ ¡éªŒTokençš„æœ‰æ•ˆæ€§ï¼šä½¿ç”¨Luaè„šæœ¬
        boolean isValid = checkTokenValidity(token);  
  
        if (!isValid) {  
            httpResponse.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  
            httpResponse.getWriter().write("Invalid or expired token");  
            logger.error("token validate failed , pls check!");  
            return;  
        }  
  
        // Tokenæœ‰æ•ˆï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–è¿‡æ»¤å™¨é“¾  
        chain.doFilter(request, response);  
    } finally {  
        tokenThreadLocal.remove();  
    }  
}

private boolean checkTokenValidity(String token) {  
    String luaScript = """  
            local value = redis.call('GET', KEYS[1])            redis.call('DEL', KEYS[1])            return value""";  
  
    // 6.2.3ä»¥ä¸Šå¯ä»¥ç›´æ¥ä½¿ç”¨GETDELå‘½ä»¤  
    // String value = (String) redisTemplate.opsForValue().getAndDelete(token);  
  
    String result = (String) redissonClient.getScript().eval(RScript.Mode.READ_WRITE,  
            luaScript,  
            RScript.ReturnType.STATUS,  
            Arrays.asList(token));  
  
    tokenThreadLocal.set(result);  
    return result != null;  
}
```

## 10. â­åŸºäºè´£ä»»é“¾æ¨¡å¼çš„ä¸‹å•å‰ç½®æ ¡éªŒ
- å³ä½¿ç½‘å…³æ¨¡å—åšäº†æ ¡éªŒï¼Œè®¢å•æ¨¡å—ä¹Ÿéœ€è¦è¿›è¡Œæ ¡éªŒï¼›ã€å•ä¸€èŒè´£ï¼Ÿã€‘

å¤šä¸ªæ ¡éªŒå™¨ã€‚é€šè¿‡è´£ä»»é“¾æ¨¡å¼ï¼Œä½¿å¾—å¤šä¸ªæ ¡éªŒå™¨èƒ½å¤ŸæŒ‰é¡ºåºæ‰§è¡Œã€‚

è´£ä»»é“¾çš„æŠ½è±¡æ¥å£ï¼šã€å†…éƒ¨æœ‰ã€Œè®¾ç½®ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨ã€å’Œã€Œå¼€å§‹æ ¡éªŒã€çš„æŠ½è±¡æ–¹æ³•ã€‘ï¼Œè¯¥æ¥å£ä¸ºæ‰€æœ‰è´£ä»»é“¾æ¨¡å¼éƒ½éœ€è¦å®ç°çš„æŠ½è±¡æ¥å£ã€‚å¯¹äºå…·ä½“çš„ä¸šåŠ¡æ ¡éªŒè´£ä»»é“¾çš„å®ç°ï¼Œé¦–å…ˆåˆ›å»ºæŠ½è±¡ç±»æ¥å®ç°è¯¥è´£ä»»é“¾æ¥å£ã€‚
```java
/**
 * è®¢å•æ ¡éªŒ
 *
 * @author Hollis
 */
 // è®¢å•æ ¡éªŒå™¨è´£ä»»é“¾
public interface OrderCreateValidator {
    /**
     * è®¾ç½®ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨
     *
     * @param nextValidator
     */
    public void setNext(OrderCreateValidator nextValidator);

    /**
     * è¿”å›ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨
     *
     * @return
     */
    public OrderCreateValidator getNext();

    /**
     * æ ¡éªŒ
     *
     * @param request
     * @throws OrderException è®¢å•å¼‚å¸¸
     */
    public void validate(OrderCreateRequest request) throws OrderException;
}

```
### æŠ½è±¡ç±»ã€ç»§æ‰¿è´£ä»»é“¾æ¥å£ã€‘
- åˆ›å»ºè®¢å•æ ¡éªŒçš„è´£ä»»é“¾æŠ½è±¡ç±»ï¼Œç»§æ‰¿å‡ ä¸ªæ–¹æ³•ã€Œè·å–ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨ã€ã€ã€Œå¼€å§‹æ ¡éªŒã€
```java
/**
 * è®¢å•æ ¡éªŒ
 *
 * @author Hollis
 */
public abstract class BaseOrderCreateValidator implements OrderCreateValidator {

    protected OrderCreateValidator nextValidator;

    @Override
    public void setNext(OrderCreateValidator nextValidator) {
        this.nextValidator = nextValidator;
    }

    @Override
    public OrderCreateValidator getNext() {
        return nextValidator;
    }

    /**
     * æ ¡éªŒ
     *
     * @param request
     * @throws Exception
     */
    @Override
    public void validate(OrderCreateRequest request) throws OrderException {
        doValidate(request);

        if (nextValidator != null) {
            nextValidator.validate(request);
        }
    }

    /**
     * æ ¡éªŒæ–¹æ³•çš„å…·ä½“å®ç°
     *
     * @param request
     * @throws OrderException
     */
    protected abstract void doValidate(OrderCreateRequest request) throws OrderException;
}

```

### å®ç°ç±»ï¼š
#### **ç”¨æˆ·æ ¡éªŒå™¨ï¼š**
6. åˆ›å»ºUserValidatorç±»ç»§æ‰¿è®¢å•æ ¡éªŒè´£ä»»é“¾æŠ½è±¡ç±»ï¼Œå¹¶å®ç°`doValidate()`æ–¹æ³•ï¼Œå®ç°ç”¨æˆ·çŠ¶æ€çš„æ ¡éªŒé€»è¾‘ã€‚
7. å®ç°ï¼šè·å–ç”¨æˆ·IDï¼Œæ‹¼æ¥è¯·æ±‚ï¼Œè°ƒç”¨Mapperå±‚æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚
8. æ ¡éªŒä¹°å®¶çš„çŠ¶æ€ï¼šâ‘ æ˜¯å¦ä¸ºé¡¾å®¢ï¼›â‘¡æ˜¯å¦å·²ä¸Šé“¾ï¼›â‘¢æ˜¯å¦å·²å®åè®¤è¯ã€‚
```java
/**  
 * ç”¨æˆ·æ ¡éªŒå™¨  
 *  
 * @author hollis  
 */@Component  
public class UserValidator extends BaseOrderCreateValidator {  
  
    @Autowired  
    private UserFacadeService userFacadeService;  
  
    @Override  
    public void doValidate(OrderCreateRequest request) throws OrderException {  
        String buyerId = request.getBuyerId();  
        UserQueryRequest userQueryRequest = new UserQueryRequest(Long.valueOf(buyerId));  
        UserQueryResponse<UserInfo> userQueryResponse = userFacadeService.query(userQueryRequest);  
        if (userQueryResponse.getSuccess() && userQueryResponse.getData() != null) {  
            UserInfo userInfo = userQueryResponse.getData();  
            if (userInfo.getUserRole() != null && !userInfo.getUserRole().equals(UserRole.CUSTOMER)) {  
                throw new OrderException(BUYER_IS_PLATFORM_USER);  
            }  
            //åˆ¤æ–­ä¹°å®¶çŠ¶æ€  
            if (userInfo.getState() != null && !userInfo.getState().equals(UserStateEnum.ACTIVE.name())) {  
                throw new OrderException(BUYER_STATUS_ABNORMAL);  
            }  
            //åˆ¤æ–­ä¹°å®¶çŠ¶æ€  
            if (userInfo.getState() != null && !userInfo.getCertification()) {  
                throw new OrderException(BUYER_NOT_AUTH);  
            }  
        }  
    }  
}
```

#### **å•†å“æ ¡éªŒå™¨ï¼š**
9. æ ¡éªŒâ‘ å•†å“æ˜¯å¦åœ¨å”®å–ä¸­ï¼›<font color="#ff0000">â‘¡å•†å“çš„ä»·æ ¼æ˜¯å¦æœ‰æ”¹åŠ¨ï¼Ÿ</font>
	- â‘¡ï¼šå¼ºæ ¡éªŒï¼Œç¡®ä¿ç”¨æˆ·æ‰€çœ‹åˆ°çš„å•†å“ä»·æ ¼å’Œå½“å‰å•†å“ä»·æ ¼ä¸€è‡´ï¼æ¶‰åŠåˆ°ã€Œå¯¹å®¢è¡¨è¾¾ã€çš„é—®é¢˜ã€‚
```java
/**
 * å•†å“æ ¡éªŒå™¨
 *
 * @author hollis
 */
@Component
public class GoodsValidator extends BaseOrderCreateValidator {

    @Autowired
    private GoodsFacadeService goodsFacadeService;

    @Override
    protected void doValidate(OrderCreateRequest request) throws OrderException {
        BaseGoodsVO baseGoodsVO = goodsFacadeService.getGoods(request.getGoodsId(), request.getGoodsType());

        if (!baseGoodsVO.available()) {
            throw new OrderException(GOODS_NOT_AVAILABLE);
        }

        if (baseGoodsVO.getPrice().compareTo(request.getItemPrice()) != 0) {
            throw new OrderException(GOODS_PRICE_CHANGED);
        }
    }
}
```

#### **åº“å­˜æ ¡éªŒå™¨ï¼š**
10. æ ¹æ®è¯·æ±‚æŸ¥è¯¢å¯¹åº”å•†å“çš„åº“å­˜ä¿¡æ¯ã€å¯å”®åº“å­˜+åº“å­˜æ€»é‡ã€‘
	- è¿™é‡Œæ³¨æ„ï¼ŒæŸ¥è¯¢è—å“åº“å­˜è—å“æ€»é‡å’Œå·²å åº“å­˜ï¼Œéƒ½æ˜¯å»MySQLæŸ¥ï¼›è€Œ**æŸ¥è¯¢å¯å”®åº“å­˜ï¼Œéœ€è¦å»Redisä¸­æŸ¥è¯¢**ï¼ã€æ•°æ®åº“çš„æ•°æ®ä¸ä¸€å®šå‡†ç¡®ï¼å› ä¸ºè¿˜æœªè¢«åŠæ—¶åŒæ­¥ã€‘
11. æ ¡éªŒï¼šâ‘ å•†å“æ˜¯å¦ä¸ºç©ºï¼›â‘¡åº“å­˜æ˜¯å¦ä¸º0ï¼›â‘¢åº“å­˜æ˜¯å¦è¶³å¤Ÿæ‰£å‡ã€‚
```java
/**
 * åº“å­˜æ ¡éªŒå™¨
 *
 * @author hollis
 */
@Component
public class StockValidator extends BaseOrderCreateValidator {

    @Autowired
    private InventoryWrapperService inventoryWrapperService;

    @Override
    public void doValidate(OrderCreateRequest request) throws OrderException {
        BaseGoodsInventoryVO goodsInventoryVO = inventoryWrapperService.queryInventory(request);

        if (goodsInventoryVO == null) {
            throw new OrderException(INVENTORY_NOT_ENOUGH);
        }

        if (goodsInventoryVO.getInventory() == 0) {
            throw new OrderException(INVENTORY_NOT_ENOUGH);
        }

        if (goodsInventoryVO.getQuantity() < request.getItemCount()) {
            throw new OrderException(INVENTORY_NOT_ENOUGH);
        }

        if (goodsInventoryVO.getInventory() < request.getItemCount()) {
            throw new OrderException(INVENTORY_NOT_ENOUGH);
        }
    }
}

```
#### è´£ä»»é“¾é“¾æ¥
å¦‚ä½•å°†å¤šä¸ªæ ¡éªŒå™¨é“¾æ¥èµ·æ¥å‘¢ï¼Ÿ
- å®šä¹‰é…ç½®ç±»`OrderCreateValidatorConfig`ï¼Œå£°æ˜Configurationæ³¨è§£ ï¼Œæ³¨å…¥éœ€è¦é“¾æ¥ç¼–æ’çš„æ ¡éªŒå™¨ï¼Œ**é€šè¿‡`setNext()`æ–¹æ³•æ¥å°†å¤šä¸ªæ ¡éªŒå™¨é“¾æ¥èµ·æ¥ã€‚** é€šè¿‡`User.setNext(goods);`,`goods.setNext(stock)`çš„æ–¹å¼ä¾æ¬¡è¿æ¥ã€‚
	- æ³¨æ„é¡ºåºï¼Œå…ˆæ ¡éªŒç”¨æˆ·ã€å†æ ¡éªŒå•†å“ä¿¡æ¯ã€æœ€åæ‰æ ¡éªŒåº“å­˜ï¼
- è¿”å›å€¼ä¸ºè®¢å•æ ¡éªŒçš„æ¥å£ã€‚
```java
/**  
 * è®¢å•åˆ›å»ºæ ¡éªŒå™¨é…ç½®  
 *  
 * @author hollis  
 */@Configuration  
public class OrderCreateValidatorConfig {  
  
    @Autowired  
    private StockValidator stockValidator;  
  
    @Autowired  
    private GoodsValidator goodsValidator;  
  
    @Autowired  
    private UserValidator userValidator;  

	// æ­¤å¤„çš„è¿”å›å€¼ä¸ºè®¢å•æ ¡éªŒçš„æ¥å£ã€‚
    @Bean  
    public OrderCreateValidator orderValidatorChain() {  
        userValidator.setNext(goodsValidator);  
        goodsValidator.setNext(stockValidator);  
        return userValidator;  
    }  
  
}
```
#### å…·ä½“ä½¿ç”¨
- é€šè¿‡<font color="#ff0000">æ¥å£å®ç°Beanæ³¨å…¥</font>ï¼Œç„¶åç›´æ¥è°ƒç”¨validateæ–¹æ³•å®ç°è´£ä»»é“¾æ ¡éªŒã€‚
- å…¶ä¸­æ¯ä¸€ä¸ªæ ¡éªŒå™¨éƒ½å®ç°äº†valida teæ–¹æ³•ï¼Œä¼šå…ˆdoValidateå®ç°å½“å‰æ ¡éªŒå™¨çš„æ ¡éªŒï¼Œç„¶åå†è°ƒç”¨ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨çš„validateä½¿å…¶å¼€å§‹æ ¡éªŒã€‚
 ```java hl:11
{   
	...
	@Autowired
	private OrderCreateValidator orderValidatorChain;

    @Override
    @DistributeLock(keyExpression = "#request.identifier", scene = "ORDER_CREATE")
    @Facade
    public OrderResponse create(OrderCreateRequest request) {
        try {
            orderValidatorChain.validate(request);
        } catch (OrderException e) {
            return new OrderResponse.OrderResponseBuilder().buildFail(ORDER_CREATE_VALID_FAILED.getCode(), e.getErrorCode().getMessage());
        }
		...
    }
    ...
}
```
#### ä¼˜ç‚¹
12. å¯ä»¥æ›´æ–¹ä¾¿çš„æ·»åŠ é¢å¤–çš„æ ¡éªŒåŠŸèƒ½ï¼Œç¬¦åˆâ€œ**å¼€é—­åŸåˆ™**â€çš„å¼€å‘è§„çº¦ã€‚ã€å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‘
	- åªéœ€è¦é¢å¤–æ–°å¢åŠ æ ¡éªŒå™¨å®ç°ç±»ï¼Œå¹¶åœ¨Configä¸­ç¼–æ’æ·»åŠ è¯¥æ ¡éªŒå™¨ï¼è‹¥æ— è´£ä»»é“¾ï¼Œå¯èƒ½éœ€è¦æ ¡éªŒæ–¹æ³•ä»£ç ï¼Œ

## 11. ç”¨æˆ·æ¨¡å—çš„ç¼“å­˜ã€ç”¨æˆ·ä¿¡æ¯çš„ç¼“å­˜ã€‘
ç”¨æˆ·ä¿¡æ¯çš„æŸ¥è¯¢æ·»åŠ äº†äºŒçº§ç¼“å­˜ï¼Œåˆ†åˆ«æ˜¯æœ¬åœ°ç¼“å­˜Caffeineå’Œåˆ†å¸ƒå¼ç¼“å­˜Redisï¼Œå‡ºäºä»¥ä¸‹å‡ ç‚¹è€ƒè™‘ï¼š
13. **ä½œä¸ºåŸºç¡€æ¨¡å—ï¼Œå…¶ä½™å¾ˆå¤šæ¨¡å—éƒ½ä¾èµ–äºç”¨æˆ·æ¨¡å—ï¼Œéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼›**
14. ç”¨æˆ·ä¿¡æ¯å˜æ›´ä¸é¢‘ç¹ï¼Œå±äº**è¯»å¤šå†™å°‘**çš„åœºæ™¯ï¼Œå› æ­¤é€‚ç”¨äºæ·»åŠ ç¼“å­˜ï¼

ç»¼ä¸Šï¼Œä¸ºäº†åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹çš„å¿«é€Ÿå“åº”ã€å‡å°‘åŠ è½½æ…¢çš„æƒ…å†µï¼Œä»¥åŠ**ä¿æŠ¤ç”¨æˆ·æœåŠ¡**ï¼Œä¸ºç”¨æˆ·æ¨¡å—æ·»åŠ äº†äºŒçº§ç¼“å­˜ã€‚

**ä¸è¿‡ï¼Œä¸æ·»åŠ ä¹Ÿæ˜¯åˆç†çš„ã€‚**
## 12. åŸºäºRedis+MQ+æ•°æ®åº“å®ç°é«˜å¹¶å‘æ‰£å‡
åœ¨Redisä¸æ•°æ®åº“ä¸­åšé¢„æ‰£å‡ã€‚å¼•å…¥Redisçš„åŸå› ï¼Œæ˜¯å‡è®¾æœ‰å¤§é‡ç”¨æˆ·ä¸‹å•ï¼Œé‚£ä¹ˆå°±ä¼šæ›´æ–°åŒä¸€è¡Œæ•°æ®ï¼Œä¹Ÿå°±æ˜¯çƒ­ç‚¹è¡Œé—®é¢˜ã€‚ç”±äºæ•°æ®åº“åœ¨æ›´æ–°æ•°æ®æ—¶**ä¼šåŠ æ‚²è§‚é”ï¼ˆè¡Œé”ï¼‰**ï¼Œå› æ­¤å…¶ä»–äº‹åŠ¡ä¼šä¸æ–­è¿›è¡Œè‡ªæ—‹å°è¯•è·å–é”ï¼Œä»¥åŠæ•°æ®åº“çš„æ­»é”æ£€æµ‹ï¼Œå¯¼è‡´æ•°æ®åº“çš„CPUæ‹‰é«˜ã€‚è€ŒRedisçš„å•çº¿ç¨‹å’ŒåŸºäºå†…å­˜çš„ç‰¹æ€§èƒ½ä¿è¯å…¶èƒ½é¡ºåºã€é«˜æ•ˆåœ°å¤„ç†æ‰£å‡è¯·æ±‚ã€‚

**è¿›ä¸€æ­¥åœ°ä¼˜åŒ–**ï¼š
- å½“Redisä¸­çš„åº“å­˜è¢«æ‰£å‡è‡³0æ—¶ï¼ŒåŒæ—¶å†™åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œæ­¤æ—¶ç”¨æˆ·å°±ä¼šç›´æ¥æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œå‘ç°åº“å­˜å·²å”®ç½„ï¼Œè¯·æ±‚å°±ä¸ä¼šæ‰“åˆ°Redisä¸Šã€‚
- ä¸è¿‡ä¹Ÿä¼šå¼•å…¥æœ¬åœ°ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå³å•†å“è‹¥æ·»åŠ åº“å­˜ï¼Œå¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜èƒ½ç«‹å³æ›´æ–°ã€‚

MQçš„ä½œç”¨ä¸»è¦ä½“ç°åœ¨å‰Šå³°å¡«è°·ï¼Œé¿å…é«˜å¹¶å‘æµé‡çŸ­æ—¶é—´å†…æ‰“åˆ°æ•°æ®åº“ä¸Šã€‚MQçš„é˜Ÿåˆ—ä»¥åŠå¼‚æ­¥æœºåˆ¶å¤©ç„¶åœ°æ”¯æŒè¿™ä¸€ç‚¹ã€‚

åŒæ—¶è¿™ä¼šå¼•å…¥ä¸€ä¸ªé—®é¢˜ï¼ŒåŒæ­¥çš„åªæœ‰Redisçš„é¢„æ‰£å‡ï¼Œå…¶ä½™çš„è®¢å•åˆ›å»ºä»¥åŠåº“å­˜çš„æ‰£å‡éƒ½åœ¨å¼‚æ­¥é“¾è·¯ä¸Šï¼Œå¦‚æœç­‰å¾…å¼‚æ­¥è¿”å›ï¼Œé‚£ä¹ˆå‰ç«¯å°±ä¼šç­‰å¾…å¤ªä¹…ï¼Œå½±å“ç”¨æˆ·ä½“éªŒï¼å› æ­¤ï¼Œå°†è®¢å•å·çš„ç”Ÿæˆæ”¾åœ¨åŒæ­¥é“¾è·¯ä¸Šï¼Œæå‰è¿”å›ç»™å‰ç«¯ã€‚

äº‹åŠ¡æ¶ˆæ¯ï¼š`boolean result = streamProducer.send("newBuy-out-0", buyParam.getGoodsType(), JSON.toJSONString(orderCreateRequest));`
- é€šè¿‡å¼•å…¥äº‹åŠ¡æ¶ˆæ¯æ¥ä¿è¯Redisçš„é¢„æ‰£å‡å’ŒMQæ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§ã€‚
- ä½†æ˜¯å¹¶ä¸èƒ½å®Œå…¨ä¿è¯ä¸€è‡´æ€§ï¼Œå› ä¸ºå¯èƒ½MQæŒ‚äº†ï¼Œè€Œæ¶ˆæ¯æ­¤æ—¶ä¹Ÿè¿˜æ²¡åˆ·ç›˜æŒä¹…åŒ–ã€‚
## 13. å……è¡€æ¨¡å‹
**å°†ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€å¯¹è±¡çš„åˆ›å»ºç­‰æ–¹æ³•æ”¾ç½®åœ¨å¯¹è±¡ç±»ä¸­**ï¼Œå®ç°ä»£ç çš„å†…èšåœ¨ç±»ä¸­ï¼Œé¿å…åœ¨å¤–éƒ¨å†—ä½™è¿‡å¤šæ¨¡å‹ä¿¡æ¯ã€‚

## 14. åŸºäºå·¥å‚æ¨¡å¼çš„å¤–éƒ¨é“¾æœåŠ¡çš„MOCKå®ç°ã€CODEã€‘
ä¾‹å¦‚åœ¨`ChainFacadeServiceImpl`éœ€è¦ä½¿ç”¨`chainService`æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼å®ç°æ ¹æ®é…ç½®åˆ‡æ¢é“¾æœåŠ¡ï¼Œè¿”å›å¯¹åº”çš„Beanå®ä¾‹ã€‚

- Valueæ³¨è§£ç”¨äºæ³¨å…¥é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å­—åˆ°è¯¥å­—æ®µä¸Šã€‚
```java
@Value("${nft.turbo.chain.type:MOCK}")  
private String chainType;  
  
@Value("${spring.profiles.active}")  
private String profile;
```
- æ ¹æ®æ³¨å…¥çš„chainTypeå’Œprofileå±æ€§è¿”å›ç›¸åº”çš„chainServiceçš„å®ä¾‹ã€‚
```java
private ChainService getChainService() {  
    if (PROFILE_DEV.equals(profile)) {  
        return chainServiceFactory.get(ChainType.MOCK);  
    }  
  
    ChainService chainService = chainServiceFactory.get(ChainType.valueOf(chainType));  
    return chainService;  
}
```
- ä½¿ç”¨Mapè¿›è¡Œè‡ªåŠ¨æ³¨å…¥ï¼ŒSpringå®¹å™¨ä¼šå°†ChainServiceæ‰€æœ‰çš„å®ç°ç±»Beanæ³¨å…¥åˆ°Mapä¸­ï¼Œé”®ä¸º Bean åç§°ï¼Œå€¼ä¸ºå¯¹åº”çš„ Bean å®ä¾‹ã€‚
- **å·¥å‚çš„å…·ä½“é€»è¾‘æ˜¯ï¼šæ ¹æ®ä¼ æ¥çš„chainTypeï¼Œè½¬æ¢ä¸ºå¯¹åº”BeanNameï¼Œç„¶åä»mapä¸­è·å–å¯¹åº”å®ä¾‹å¹¶è¿”å›ï¼ï¼**
```java
/**  
 * é“¾æœåŠ¡å·¥å‚  
 *  
 * @author hollis  
 */@Service  
public class ChainServiceFactory {  
  
    @Autowired  
    private final Map<String, ChainService> chainServiceMap = new ConcurrentHashMap<String, ChainService>();  
  
    public ChainService get(ChainType chainType) {  
        String beanName = BeanNameUtils.getBeanName(chainType.name(), "ChainService");  
  
        //ç»„è£…å‡ºbeanNameï¼Œå¹¶ä»mapä¸­è·å–å¯¹åº”çš„bean  
        ChainService service = chainServiceMap.get(beanName);  
  
        if (service != null) {  
            return service;  
        } else {  
            throw new UnsupportedOperationException(  
                    "No ChainService Found With chainType : " + chainType);  
        }  
    }  
}
```

```java
public static String getBeanName(String strategyName, String serviceName) {  
    //å°†æœåŠ¡è½¬æ¢æˆå°å†™å­—æ¯å¼€å¤´çš„é©¼å³°å½¢å¼ï¼Œå¦‚A_BCD è½¬æˆ aBcd    return CaseFormat.UPPER_UNDERSCORE.converterTo(CaseFormat.LOWER_CAMEL).convert(strategyName) + serviceName;  
}
```
## 15. åŸºäºShardingSphereçš„è®¢å•è¡¨åˆ†è¡¨ ã€TODOã€‘

#### â­è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³• TODO
å› ä¸ºè®¢å•å·ç¼–ç äº†ä¹°å®¶IDï¼Œå› æ­¤æ—¢å¯ä»¥æ ¹æ®buyer_idï¼Œä¹Ÿå¯ä»¥æ ¹æ®è®¢å•å·è·å–åˆ†è¡¨ç»“æœï¼Œå³å®šä½åˆ°æŸå¼ è¡¨ã€‚


## 16. åŸºäºRocketMQçš„è®¢å•å–æ¶ˆ
15. è®¢å•æ¨¡å—å‘é€åŠæ¶ˆæ¯ç»™RocketMQï¼›
16. åŠæ¶ˆæ¯å‘é€æˆåŠŸï¼Œåˆ™è¿›è¡Œè®¢å•å–æ¶ˆæ“ä½œï¼›
17. è®¢å•å–æ¶ˆæˆåŠŸï¼Œåˆ™å‘é€COMMITæ¶ˆæ¯ï¼ŒMQå†é€šçŸ¥è—å“æ¨¡å—è¿›è¡Œåº“å­˜å›æ»šï¼›è®¢å•å–æ¶ˆå¤±è´¥ï¼Œåˆ™å‘é€RollBackå›æ»šæ“ä½œï¼Œå–æ¶ˆæ“ä½œã€‚
	1. **è‹¥COMMITæˆ–ROLLBACKæ¶ˆæ¯ï¼ˆå³ç¬¬äºŒä¸ªåŠæ¶ˆæ¯ï¼‰å‘é€å¤±è´¥**ï¼Œåˆ™éœ€è¦MQå›è°ƒåæŸ¥è®¢å•æ¨¡å—ï¼Œåˆ¤æ–­è®¢å•æ˜¯å¦å–æ¶ˆæˆåŠŸæ¥å†³å®šæ˜¯å¦å‘é€æ¶ˆæ¯ç»™è—å“æ¨¡å—è¿›è¡Œåº“å­˜çš„å›æ»šæ“ä½œã€‚


## 17. åŸºäºXXL-JOBå®ç°è®¢å•çš„è¶…æ—¶å…³é—­

#### ä¸ºä»€ä¹ˆç”¨å®šæ—¶ä»»åŠ¡è€Œä¸æ˜¯MQå»¶è¿Ÿæ¶ˆæ¯ï¼Ÿ
- åŸºäºMQå»¶è¿Ÿæ¶ˆæ¯ï¼Œç”±äºMQçš„ä¸å¯é æ€§ï¼Œå› æ­¤å¯èƒ½ä¼šå› ä¸ºâ‘ **å¯é æ€§ä¸å¤Ÿ**ï¼šæ¶ˆæ¯ä¸¢å¤±è€Œå¯¼è‡´è®¢å•æ²¡æœ‰è¢«æˆåŠŸå…³é—­ï¼›â‘¡**æ— æ•ˆæ¶ˆæ¯**ï¼šè¶…æ—¶å…³å•çš„è®¢å•å æ¯”ä¸å¤§ï¼Œä¼šå¯¼è‡´æœ‰å¤§é‡çš„æ— æ•ˆä»»åŠ¡å †ç§¯ï¼Œæµªè´¹èµ„æºã€‚
- è€ŒåŸºäºå®šæ—¶ä»»åŠ¡æ‰«è¡¨çš„æ“ä½œï¼Œç”±äºè®¢å•æ•°æ®åœ¨æ•°æ®åº“ä¸­æŒä¹…åŒ–äº†ï¼Œå› æ­¤èƒ½ä¿è¯è®¢å•æœ€ç»ˆä¼šè¢«æˆåŠŸå…³é—­ã€‚ä¸è¿‡å®šæ—¶ä»»åŠ¡ä¹Ÿä¼šæœ‰â‘ å»¶è¿Ÿé—®é¢˜ï¼ˆç§’çº§ï¼Œå¤§éƒ¨åˆ†åœºæ™¯å½±å“ä¸å¤§ï¼‰ï¼›â‘¡æ€§èƒ½é—®é¢˜ï¼šå®šæ—¶ä»»åŠ¡æ‰«è¡¨ï¼Œè‹¥è¡¨ä¸­æ•°æ®é‡è¿‡å¤§ï¼Œåˆ™ä¹Ÿä¼šé€ æˆå †ç§¯ã€‚
	- æ€§èƒ½é—®é¢˜é€šè¿‡XXL-JOBçš„åˆ†ç‰‡ä»»åŠ¡ã€åˆ†åº“åˆ†è¡¨ç­‰å®ç°åŠ é€Ÿæ‰«è¡¨ï¼Œé€šè¿‡çº¿ç¨‹æ± å®ç°å¹¶å‘æ¶ˆè´¹ã€‚
	- å»¶è¿Ÿé—®é¢˜é€šè¿‡æå‰å–å‡ºå°†è¦è¶…æ—¶çš„ä»»åŠ¡ã€æŸ¥çœ‹è®¢å•è¯¦æƒ…æ—¶çš„ä¸»åŠ¨å…³å•ç­‰æ“ä½œæ¥ä¿è¯ã€‚

#### XXL-JOBçš„åˆ†ç‰‡å®ç°åˆ†åº“åˆ†è¡¨åçš„æ‰«è¡¨
å¯ç”¨å¤šå°æœºå™¨è¿›è¡Œæ‰«è¡¨ä»»åŠ¡ï¼ŒXXL-JOBçš„æ‰«è¡¨ä»»åŠ¡ç±»å‹é€‰æ‹©ã€Œ**åˆ†ç‰‡å¹¿æ’­**ã€ï¼Œé‚£ä¹ˆå½“æœ‰æ‰«è¡¨ä»»åŠ¡æ—¶ï¼Œå°±ä¼šé€šçŸ¥æ‰€æœ‰å®ä¾‹è¿›è¡Œæ‰«è¡¨æ“ä½œï¼ˆ[[#é‡å¤é—®é¢˜]]ï¼Ÿï¼‰ã€‚

##### é‡å¤é—®é¢˜
åœ¨å¯ç”¨åˆ†ç‰‡ä»»åŠ¡åï¼Œéœ€è¦ä¼ é€’ç»™æ¯ä¸ªæœºå™¨ä¸¤ä¸ªå‚æ•°ï¼š`shardingTotal`å’Œ`shardingIndex`ï¼Œå‰è€…è¡¨ç¤ºæ€»çš„å®ä¾‹æ•°ç›®ï¼Œåè€…è¡¨ç¤ºå½“å‰æœºå™¨çš„ç¼–å·ã€‚åœ¨æ¯ä¸ªæœºå™¨è·å¾—è¿™ä¸¤ä¸ªå‚æ•°åï¼Œå°±å¯ä»¥åŸºäºæ­¤è¿›è¡Œæ•°æ®éš”ç¦»ã€‚
- ä¾‹å¦‚åˆ†ç‰‡æ€»æ•°æ˜¯4ï¼Œå½“å‰å®ä¾‹çš„ç¼–å·1ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨æ‰«è¡¨æ—¶ï¼Œæ ¹æ®æŸä¸ªå­—æ®µï¼ˆä¾‹å¦‚ä¸»é”®IDã€ç”¨æˆ·IDç­‰ï¼‰å–æ¨¡è¿›è¡Œæ‰«è¡¨ï¼Œæ¯ä¸ªæœºå™¨åªæ‰«æå¯¹åº”ç¬¦å·æ¡ä»¶çš„æ•°æ®ï¼Œä»¥æ­¤å®ç°æ•°æ®éš”ç¦»ã€‚
![[Pasted image 20250209202603.png]]

##### å•æœºæ€§èƒ½é—®é¢˜
ç”±ä»¥ä¸‹2ä¸ªæ–¹å¼æ¥è§£å†³ï¼š
18. åˆ©ç”¨é˜»å¡é˜Ÿåˆ—BlockingQueueå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œç”Ÿäº§è€…åªè´Ÿè´£æ‰«æéœ€è¦å…³é—­çš„è®¢å•ï¼Œæ¶ˆè´¹è€…åªè´Ÿè´£æ‰§è¡Œå…³é—­è®¢å•æ“ä½œã€‚
19. ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½é‡‡ç”¨å¤šçº¿ç¨‹ForkJoinPoolç»„æˆï¼Œä»¥æé«˜å¹¶å‘æ€§èƒ½ï¼

ä¼šå‡ºç°ä»¥ä¸‹å‡ ç§é—®é¢˜ï¼š
- æ¶ˆè´¹è€…é€Ÿåº¦è¿‡å¿«ï¼Œå¯¼è‡´é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®è€Œæå‰ç»“æŸï¼Œåç»­ç”Ÿäº§è€…å†ç”Ÿäº§çš„æ¶ˆæ¯å°±æ— æ³•è¢«æ¶ˆè´¹ã€‚
	- é€šè¿‡**æ¯’ä¸¸å¯¹è±¡**å®ç°ï¼šåœ¨æ‰€æœ‰éœ€è¦å…³é—­çš„è®¢å•è¢«æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—åå†æ·»åŠ ä¸€ä¸ªæ¯’ä¸¸å¯¹è±¡ï¼Œå½“æ¶ˆè´¹è€…æ‹¿åˆ°æ¯’ä¸¸å¯¹è±¡åï¼Œè¯´æ˜ç”Ÿäº§è€…å·²æ·»åŠ æ‰€æœ‰éœ€è¦å…³é—­çš„è®¢å•ï¼Œæ¶ˆè´¹è€…ä¹Ÿå¯ç»“æŸã€‚


## 18. MOCKæ”¯ä»˜æ¨¡å—æ—¶åŸºäºTTLçš„æ”¯ä»˜å›è°ƒå‚æ•°ä¼ é€’


## 19. åŸºäºSeataçš„æ”¯ä»˜ç¯èŠ‚çš„æ•°æ®ä¸€è‡´æ€§
å¤šæœåŠ¡æ•´åˆï¼Œç›¸äº’è°ƒç”¨ï¼Œæ¶‰åŠåˆ°å¤šä¸ªæ¨¡å—ã€å¤šä¸ªåŸŸï¼Œéœ€è¦ä½¿ç”¨Seataåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¿è¯è¿œç¨‹è°ƒç”¨ä¹Ÿèƒ½å›æ»šã€‚
#### äº‹åŠ¡å¤±æ•ˆåŸå› 
é¦–å…ˆæ˜ç¡®ï¼Œäº‹åŠ¡ç”Ÿæ•ˆçš„ä¿è¯æ˜¯å„æ¨¡å—ä¹‹é—´å…·æœ‰ç›¸åŒçš„å…¨å±€äº‹åŠ¡XIDã€‚

å‡ºç°åŸå› ï¼šå…¨å±€äº‹åŠ¡XIDæ²¡èƒ½åœ¨å„ä¸ªæ¨¡å—ä¹‹é—´ä¼ é€’ï¼Œå¯¼è‡´äº‹åŠ¡å¤±æ•ˆã€‚å„æ¨¡å—ï¼ˆå¦‚tradeã€payç­‰æ¨¡å—éƒ½åœ¨businessæ¨¡å—ä¸­


## 20. åŸºäºSeataçš„äº‹åŠ¡é’©å­Hook+å®šæ—¶ä»»åŠ¡ä¿è¯ä¸Šé“¾çš„ä¸€è‡´æ€§
åœ¨åˆ†å¸ƒå¼äº‹åŠ¡æäº¤(`afterCommit`)åï¼Œå³å®Œæˆå‰é¢5æ­¥æ“ä½œåï¼Œä¿è¯è—å“ä¸Šé“¾æ“ä½œçš„æˆåŠŸã€‚

```java
@Override  
public void afterCommit() {  
    log.info("transaction is commit ,start to mint , heldCollectionId : " + heldCollectionId);  
    SingleResponse<HeldCollectionVO> response = collectionFacadeService.queryHeldCollectionById(heldCollectionId);  
  
    if (response.getSuccess()) {  
        HeldCollectionVO heldCollection = response.getData();  
        UserQueryRequest userQueryRequest = new UserQueryRequest(Long.valueOf(heldCollection.getUserId()));  
        UserQueryResponse<UserInfo> userQueryResponse = userFacadeService.query(userQueryRequest);  
  
        ChainProcessRequest chainProcessRequest = new ChainProcessRequest();  
        chainProcessRequest.setRecipient(userQueryResponse.getData().getBlockChainUrl());  
        chainProcessRequest.setClassId(heldCollection.getCollectionId().toString());  
        chainProcessRequest.setClassName(heldCollection.getName());  
        chainProcessRequest.setSerialNo(heldCollection.getSerialNo());  
        chainProcessRequest.setBizId(heldCollection.getId().toString());  
        chainProcessRequest.setBizType(ChainOperateBizTypeEnum.HELD_COLLECTION.name());  
        chainProcessRequest.setIdentifier(heldCollection.getId().toString());  
  
        //å¦‚æœå¤±è´¥äº†ï¼Œåˆ™ä¾é å®šæ—¶ä»»åŠ¡è¡¥å¿  
        RemoteCallWrapper.call(req -> chainFacadeService.mint(req), chainProcessRequest, "mint");  
        log.info("transaction is commit ,end to mint , heldCollectionId : " + heldCollectionId);  
    }  
}
```

20. 
```java
/**  
 * è—å“ä¸Šé“¾é“¸é€ é‡è¯•ä»»åŠ¡  
 *  
 * @author Hollis  
 */@Component  
public class CollectionChainMintRetryJob {  
  
    @Autowired  
    private HeldCollectionService heldCollectionService;  
  
    @Autowired  
    private ChainFacadeService chainFacadeService;  
  
    @Autowired  
    private UserFacadeService userFacadeService;  
  
    private static final int PAGE_SIZE = 100;  
  
    private static final Logger LOG = LoggerFactory.getLogger(CollectionChainMintRetryJob.class);  
  
    @XxlJob("collectionChainMintRetryJob")  
    public ReturnT<String> execute() {  
  
        int currentPage = 1;  
        Page<HeldCollection> page = heldCollectionService.pageQueryForChainMint(currentPage, PAGE_SIZE);  
  
        page.getRecords().forEach(this::executeSingle);  
  
        while (page.hasNext()) {  
            currentPage++;  
            page = heldCollectionService.pageQueryForChainMint(currentPage, PAGE_SIZE);  
            page.getRecords().forEach(this::executeSingle);  
        }  
  
        return ReturnT.SUCCESS;  
    }  
  
    private void executeSingle(HeldCollection heldCollection) {  
        LOG.info("start to execute chainMint retry , heldCollectionId is {}", heldCollection.getId());  
  
        UserQueryRequest userQueryRequest = new UserQueryRequest(Long.valueOf(heldCollection.getUserId()));  
        UserQueryResponse<UserInfo> userQueryResponse = userFacadeService.query(userQueryRequest);  
  
        ChainProcessRequest chainProcessRequest = new ChainProcessRequest();  
        chainProcessRequest.setRecipient(userQueryResponse.getData().getBlockChainUrl());  
        chainProcessRequest.setClassId(heldCollection.getCollectionId().toString());  
        chainProcessRequest.setClassName(heldCollection.getName());  
        chainProcessRequest.setSerialNo(heldCollection.getSerialNo());  
        chainProcessRequest.setBizId(heldCollection.getId().toString());  
        chainProcessRequest.setBizType(ChainOperateBizTypeEnum.HELD_COLLECTION.name());  
        chainProcessRequest.setIdentifier(heldCollection.getId().toString());  
  
        //å¦‚æœå¤±è´¥äº†ï¼Œåˆ™ä¾é å®šæ—¶ä»»åŠ¡è¡¥å¿  
        RemoteCallWrapper.call(req -> chainFacadeService.mint(req), chainProcessRequest, "mint");  
        LOG.info("transaction is commit ,end to mint , heldCollectionId : " + heldCollection.getId());  
    }  
}
```

## 21. Orderå¯Œå®¢æˆ·ç«¯æ€æƒ³
`nft-turbo-order-client`

## 22. Convertorå®ç°å‚æ•°æ˜ å°„
21. é«˜é¢‘åœºæ™¯éœ€æ±‚ã€å¤æ‚çš„æ˜ å°„å…³ç³»ã€‚
22. ç®€å•çš„è½¬æ¢ç›´æ¥è°ƒç”¨Springçš„BeanUtilså³å¯ã€‚
åŸºäºMapStruct

## 23. é‡æ„"åº“å­˜æ‰£å‡Confirmçš„å¹¶å‘é—®é¢˜"

## 24. å‹æµ‹æ ‡isStress