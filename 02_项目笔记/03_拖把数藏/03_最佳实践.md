## 1. åŸºäºRedissonæ»‘åŠ¨çª—å£å®ç°éªŒè¯ç å‘é€é™æµ
åŸºäºRedissonçš„ä»¤ç‰Œæ¡¶ï¼Œä½†æ˜¯å°†ä»¤ç‰Œæ¡¶çš„è¯·æ±‚æ•°è®¾ç½®ä¸º1æ—¶ï¼Œæ­¤æ—¶ä»¤ç‰Œæ¡¶å°±é€€åŒ–æˆæ»‘åŠ¨çª—å£ã€‚

## 2. è‡ªå®šä¹‰ TypeHandler å®ç°éšç§æ•°æ®è‡ªåŠ¨åŠ è§£å¯† TODO

## 3. åŸºäºZSetå®ç°æ’è¡Œæ¦œåŠŸèƒ½
### ğŸ”éœ€æ±‚åˆ†æ
- è·å–ç”¨æˆ·çš„é‚€è¯·æ’åï¼šæ ¹æ®ç”¨æˆ·ç§¯åˆ†ä»é«˜åˆ°ä½è¿›è¡Œæ’åºã€‚å¤§æ¦‚å±•ç¤ºä¸ºï¼š`ç”¨æˆ·ID-æ’å-ç§¯åˆ†`
- è·å–æˆ‘çš„æ’åï¼šç”¨æˆ·èƒ½æŸ¥çœ‹è‡ªå·±åœ¨æ’è¡Œæ¦œä¸­çš„æ’åã€‚
### ğŸ’¾å­˜å‚¨è®¾è®¡
- åŸºäºéœ€æ±‚åˆ†æï¼Œé‡‡ç”¨ZSetè¿›è¡Œå­˜å‚¨ï¼Œèƒ½æ ¹æ®ZSetçš„å¯¹åº”æ–¹æ³•å®ç°ä¸Šè¿°åŠŸèƒ½ã€‚
- KEYä¸ºinviteRankï¼ŒMemberä¸ºç”¨æˆ·IDï¼ŒScoreä¸ºç§¯åˆ†ï¼ŒZSetä¼šé»˜è®¤æŒ‰ç…§ç§¯åˆ†è¿›è¡Œå‡åºæ’åˆ—ã€‚
### ğŸ”Œæ¥å£è®¾è®¡
#### 1. è·å–æ’è¡Œæ¦œ
- ä½¿ç”¨`ZREVRANGEBYSCORE`æ–¹æ³•è·å–æŒ‰ç…§åˆ†æ•°ç”±é«˜åˆ°ä½çš„æ’åã€‚
```java
//æŒ‰ç…§åˆ†æ•°ä»é«˜åˆ°ä½ï¼Œè·å–å‰Nä¸ªç”¨æˆ·çš„æ’åä¿¡æ¯
public List<InviteRankInfo> getTopN(Integer topN) {
	// ä¼ å…¥èµ·ç‚¹ä¸ç»ˆç‚¹ï¼Œè·å–å‰Nä¸ªç”¨æˆ·çš„æ’åã€‚
    Collection<ScoredEntry<String>> rankInfos = inviteRank.entryRangeReversed(0, topN - 1);

    List<InviteRankInfo> inviteRankInfos = new ArrayList<>();

    if (rankInfos != null) {
        for (ScoredEntry<String> rankInfo : rankInfos) {
            InviteRankInfo inviteRankInfo = new InviteRankInfo();
            // æ ¹æ®Memberè·å–ç”¨æˆ·ID
            String userId = rankInfo.getValue();
            // æ ¹æ®MemberæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç”¨äºè¿”å›å‰ç«¯å±•ç¤º
            if (StringUtils.isNotBlank(userId)) {
                User user = findById(Long.valueOf(userId));
                if (user != null) {
	                // æ˜µç§°
                    inviteRankInfo.setNickName(user.getNickName());
                    // é‚€è¯·ç 
                    inviteRankInfo.setInviteCode(user.getInviteCode());
                    // é‚€è¯·äººæ•°ï¼Œå› ä¸ºé‚€è¯·ä¸€ä¸ªäººåˆ†æ•°+100.
                    inviteRankInfo.setInviteCount(rankInfo.getScore().intValue() / 100);
                    // è¿”å›topNç”¨æˆ·ä¿¡æ¯é›†åˆç»™å‰ç«¯
                    inviteRankInfos.add(inviteRankInfo);
                }
            }
        }
    }

    return inviteRankInfos;
}
```
#### 2. è·å–æˆ‘çš„æ’å
- ä½¿ç”¨`ZREVRANK`æ–¹æ³•å®ç°æŒ‰ç…§åˆ†æ•°ç”±é«˜åˆ°ä½æ’åºæ—¶ï¼Œæˆå‘˜Memberçš„æ’åã€‚
```java
//è·å–æŒ‡å®šç”¨æˆ·çš„æ’åï¼ŒæŒ‰ç…§åˆ†æ•°ä»é«˜åˆ°ä½
public Integer getInviteRank(String userId) {
    Integer rank = inviteRank.revRank(userId);
    if (rank != null) {
	    // å› æ­¤ä»¥0ä½œä¸ºèµ·ç‚¹ï¼Œæ‰€ä»¥éœ€è¦+1
        return rank + 1;
    }
    return null;
}
```
#### 3. æ›´æ–°æ’å
- ç”¨æˆ·åœ¨æ³¨å†Œæ—¶è‹¥å¡«å†™äº†é‚€è¯·ç ï¼Œåˆ™ä¼šå¢åŠ å¯¹åº”é‚€è¯·ç çš„ç§¯åˆ†ã€‚å¯¹åº”ä½¿ç”¨ZINCRBYå‘½ä»¤å®ç°ã€‚
- ä¸ºäº†é¿å…å¹¶å‘é—®é¢˜ï¼Œä½¿ç”¨Redissonå¯¹é‚€è¯·äººIDåŠ é”ã€‚å› ä¸ºé“¾è·¯è¾ƒçŸ­ï¼Œæ‰§è¡Œè¾ƒå¿«ï¼Œå› æ­¤åŠ é”è€Œä¸ç”¨Luaè„šæœ¬ï¼Œä¹Ÿä¸ä¼šå¤ªå½±å“ç”¨æˆ·ä½“éªŒã€‚
```java
private void updateInviteRank(String inviterId) {
    // å¦‚æœé‚€è¯·è€…IDä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œæ“ä½œ
    if (inviterId == null) {
        return;
    }

    // è·å–Redissonçš„é”å¯¹è±¡
    RLock rLock = redissonClient.getLock(inviterId);
    // å¯¹é‚€è¯·è€…IDå¯¹åº”çš„é”è¿›è¡ŒåŠ é”æ“ä½œï¼Œé¿å…å¹¶å‘æ›´æ–°
    rLock.lock();
    try {
        // è·å–é‚€è¯·è€…çš„å½“å‰æ’ååˆ†æ•°
        Double score = inviteRank.getScore(inviterId);
        // å¦‚æœå½“å‰åˆ†æ•°ä¸ºç©ºï¼Œåˆ™è®¾ç½®é»˜è®¤ä¸º0.0
        if (score == null) {
            score = 0.0;
        }
        // å°†é‚€è¯·è€…çš„æ’ååˆ†æ•°å¢åŠ 100.0ï¼Œå¹¶æ›´æ–°åˆ°æ’è¡Œæ¦œä¸­
        inviteRank.add(score + 100.0, inviterId);
    } finally {
        // æœ€ç»ˆé‡Šæ”¾é‚€è¯·è€…IDå¯¹åº”çš„é”
        rLock.unlock();
    }
}
```
### ğŸ™‹ğŸ»â€â™‚ï¸é—®é¢˜åˆ†æ
#### ä½¿ç”¨ZSetå­˜å‚¨ï¼Œæ²¡æœ‰æŒä¹…åŒ–å’‹åŠï¼Ÿ
- ä¸€æ˜¯æ’è¡Œæ¦œæ•°æ®ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œå› æ­¤æ— éœ€ä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–ï¼Œå¯ä»¥ä½¿ç”¨RedisæŒä¹…åŒ–å®ç°ï¼›
- äºŒæ˜¯è‹¥Rediså®•æœºæ•°æ®ä¸¢å¤±äº†ï¼Œå¯ä»¥å®šæ—¶åˆ°æ•°æ®åº“æŸ¥ä¸€æ¬¡ï¼Œåˆ©ç”¨`where invite_id = #{id}`å°±å¯ä»¥æŸ¥è¯¢å‡ºè¯¥ç”¨æˆ·çš„é‚€è¯·äººæ•°ã€‚
- å¯¹äºæ›´æ–°ä¸é¢‘ç¹çš„æ’è¡Œæ¦œæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨RDBæŒä¹…åŒ–ã€‚å°†saveé…ç½®å‚æ•°è®¾ç½®ä¸ºé€‚å½“çš„å€¼ï¼Œä»¥å¹³è¡¡æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ï¼›åŒæ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡ŒBGSAVEæˆ–SAVEå‘½ä»¤æ¥åˆ›å»ºæ•°æ®é›†å¿«ç…§ã€‚
- å¯¹äºæ›´æ–°é¢‘ç¹çš„æ’è¡Œæ¦œæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨AOFæŒä¹…åŒ–ï¼Œå¹¶è®¾ç½®`appendfsync`å‚æ•°æ¥æ§åˆ¶AOFæ–‡ä»¶çš„åŒæ­¥é¢‘ç‡ã€‚

## 4. åŸºäºElasticSearchå®ç°è—å“æœç´¢ TODO

ä½¿ç”¨ESæ—¶ï¼Œå¾€å¾€éƒ½æ˜¯åŸºäºä¸¤ä¸ªç›®çš„ï¼š
1. ä½¿ç”¨æœç´¢åŠŸèƒ½ï¼Œéœ€è¦å€’æ’ç´¢å¼•ï¼›
2. ä½¿ç”¨å®½è¡¨ï¼Œéœ€è¦å¤šè¡¨Join
### æ·±åˆ†é¡µä¼˜åŒ–
### ESå’ŒDBçš„åŠ¨æ€åˆ‡æ¢
- é¦–å…ˆæ˜¯CollectionServiceçš„æ¥å£ï¼Œåœ¨Beanå£°æ˜æ—¶ä½¿ç”¨æ¥å£è¿›è¡Œå£°æ˜ï¼›
- åœ¨å®ç°ç±»ä¸­ï¼Œå®šä¹‰CollectionEsServiceå’ŒCollectionDbServiceä¸¤ä¸ªå®ç°ç±»ï¼Œæ­¤æ—¶Beanå£°æ˜åº”è¯¥ä¼šæŠ¥é”™ï¼Œå› ä¸ºSpringæ¡†æ¶ä¸çŸ¥é“å…·ä½“è¦æ³¨å…¥å“ªä¸ªBeanï¼›
- åœ¨CollectionDbServiceä¸­æ·»åŠ æ³¨è§£`@ConditionalOnProperty()`ï¼Œæ­¤æ—¶åœ¨é…ç½®æ–‡ä»¶å®ç°å¯¹åº”é…ç½®ï¼Œå°±å¯ä»¥å®ç°åŠ¨æ€åˆ‡æ¢ã€‚

```java
@Service  
@ConditionalOnProperty(name = "spring.elasticsearch.enable", havingValue = "false", matchIfMissing = true)  
public class CollectionDbService extends BaseCollectionService {
	...
}
```
```yml
[es.yml]
spring:
  elasticsearch:
    enable: ${nft.turbo.elasticsearch.enable}
    uris: http://${nft.turbo.elasticsearch.url}
    username: ${nft.turbo.elasticsearch.username}
    password: ${nft.turbo.elasticsearch.password}
```


