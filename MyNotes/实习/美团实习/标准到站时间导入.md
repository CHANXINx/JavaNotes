## 一、背景

PRD: [20250710定点到站标准到站时间透传给司机](https://km.sankuai.com/collabpage/2717762893)

### 1、背景

**定点到站背景**：波次和订次优化”项目中，通过【多波次到站】对缺货和短保品成本进行治理，在【运-站】环节识别到机会点：到站时间不稳定，影响订货准确性，进而导致缺货、损耗和上架冗余工时等问题：当前在冷藏波次上测试的定点到站，将12点前到站的波次拆分为10点前/11点前/12点前三个时间段，但实际到站时间还是存在较大方差（仅20~25%在定点前一小时内到）；业务为规避不稳定，只能对安全库存进行预估，偏高时会有商品积压导致上架冗余工时和商品损耗，偏低时会导致缺货。

**定点到站杭州试点背景**：当前定点到站项目在杭州生鲜仓试点，准点率W24 53%不达标，影响准点率的ETA准确率49%也不达标；为提升ETA准确率、准点率提出优化策略，以及数据需求帮助监控、分析不准点case，和ETA不准case。

**在站时长预测基于商分分析报告优化**：商分基于过去司机在站作业时长，根据影响因素托盘数、站点卸货困难程度、有无返仓任务综合给出在站时长计算公式

[20250526 站运交接时长分析](https://km.sankuai.com/collabpage/2711026932)

### 2、目标

定点到站顺利完成试点

## 二、需求反讲
![[Pasted image 20250806151438.png]]
1. 导入逻辑可以选择短期方案简单做或者长期方案彻底产品化
    
    1. 短期方案：手动上传Excel，运维接口导入，解析存储
        
    2. 长期方案：做到芥末页面，调度导出模板，填写标准到站时间配置，上传导入，解析存储
        

## 三、详细设计

### 1、标准到站时间
1. 实现运维接口，接口参数给定S3链接，下载S3链接并解析Excel，将解析的内容存储到DB中
    
    1. 该运输接口甚至可以不用上线，直接在ST运行也可以
        
2. 接口参数：
    
    1. S3链接URL，可以事先将导入标准时间Excel上传S3后获得
        
        1. 复用Bucket：[mall-dop-auto-route]
            
    2. 运输组id，每次只能导入一个运输组的配置
        
3. 导入标准时间Excel格式
    
    1. 始发仓名称，波次，平峰/高峰、门店名称，是否展示，开始标准到站时间，结束标准到站时间
        
4. 校验逻辑
    
    1. 始发仓、门店名称均为当前运输组内的仓店，如果有错误，直接给出错误提示
        
    2. 波次，建议从MCC：outbound_delivery_tag_config中读取仓对应的波次，如果不在配置中给出报错提示
        
    3. 平峰/高峰，限定取值范围
        
    4. 是否展示提示文案，文案提示标志
        
    5. 开始标准到站时间必须不晚于结束标准到站时间，建议上传的时候使用绝对时间，后续解析为相对时间
        
        1. 如果开始结束相同则表示是一个时间点
            
        2. 如果开始结束不同则表示是一个时间端
            
5. 更新逻辑
    
    1. 以门店维度进行更新
        
6. 存储逻辑，建议复用TOS表#**customer_delivery_address_config**
    
    1. 字段取值
        
![[Pasted image 20250806151040.png|300]]
1：考勤规则配置

    2. config_value配置如下
        
        1. beginDay，开始日期表示，0表示 T日，1表示 T+1日
            
        2. beginTime，开始时间
            
        3. endDay，结束日期表示，0表示 T日，1表示 T+1日
            
        4. endTime，结束时间
            
        5. 这块的解析逻辑可以参考考勤规则配置：
```json
{
  "identifyCode": "100014826",
  "addressCode": "10000401",
  "addressName": "测试和田-体育场RDC-HT0008",
  "standardTimeConfigList": [
    {
      "srcRdcIdentifyCode": "100014826",
      "srcRdcAddressCode": "10000401",
      "srcRdcAddressName": "测试和田-体育场RDC-HT0008",
      "deliveryTag": 2,
      "peak": 0,
      "showIcon": 0,
      "beginDay": 0,
      "beginTime": "15:00",
      "endDay": 0,
      "endTime": "16:00"
    },
    {
      "srcRdcIdentifyCode": "100014826",
      "srcRdcAddressCode": "10000401",
      "srcRdcAddressName": "测试和田-体育场RDC-HT0008",
      "deliveryTag": 1,
      "peak": 0,
      "showIcon": 1,
      "beginDay": 0,
      "beginTime": "23:30",
      "endDay": 1,
      "endTime": "00:30"
    }
  ]
}
```
### 2、存储设计

#### 2.1、表设计

具体见现有表：

malltms / mall_tms_operate#**customer_delivery_address_config**

#### **2.2、字段评估**

需要评估一下config_value是否有超过字段长度的风险，当前配置为varchar(4000)

考虑到config_value为有多个维度，若varchar(4000)，则一个门店大概只能存储13种配置，因此将varchar(4000)升级为text类型。

#### 2.3 lion配置

|appKey|key|配置值|说明|备注|
|---|---|---|---|---|
|TBAPI|standard_arrive_time_show_info||定点到站标准到站时间-提示文案配置|JSON格式，by仓by波次<br><br>```<br>[<br>  {<br>    "addressCode": "10001",<br>    "deliveryTagShowInfoMap": {<br>      "2": "当前时间仅为测试阶段，暂不考核",<br>      "3": "当前时间仅为测试阶段，暂不考核", <br>      "1": "当前时间仅为测试阶段，暂不考核"<br>    }<br>  },<br>  {<br>    "addressCode": "10002",<br>    "deliveryTagShowInfoMap": {<br>      "1": "当前时间仅为测试阶段，暂不考核",<br>      "3": "当前时间仅为测试阶段，暂不考核"<br>    }<br>  }<br>]<br>```|
|standard_arrive_time_gray_poi_list||灰度展示接单站点列表|JSON格式|

![[Pasted image 20250815004005.png]]