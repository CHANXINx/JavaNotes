
## 当前痛点（为什么需要迁移）【背景】

**痛点：** 新开仓开城配置，需要业务写Wiki，然后由研发转换为Json格式，更改Lion配置。对业务和研发来说，都是一项费时的工作。
**根本原因：** Lion配置相关业务配置是Json格式的，专业性较强，对业务不友好，容易配错。

经过调研之后，对于这类业务配置，发现海马平台比Lion平台更适合这样的场景。
> 目前的新开仓开城配置添加流程：
> ①业务将需要配置的内容写到wiki，并通知研发 → ②研发根据wiki对应更新到Lion中 → ③完成并反馈业务

## 海马平台介绍

### 海马平台是什么？
海马是一个稳定、灵活、高效的运营配置管理平台。致力于整合运营配置资源，为用户提供系统化、流程化、高效率的运营配置服务。

#### 海马平台的基本概念
**运营位**
- 在海马平台中，基本的概念为运营位。一个运营位由一个或多个字段组成。字段可分为外层和里层两种类型，决定了该运营位是否是双层结构。
- 如下，运营位有4个字段，分为2个外层和1个内层。
### 海马平台的功能

#### 配置功能

我们可以通过添加运营位、添加字段来实现与Lion平台相同的配置功能。由于海马中运营位中可以设置多个字段，因此一个运营位可对应于Lion中的一个或多个配置
#### 环境隔离
海马可支持泳道和Set化隔离。支持配置先在某个泳道生效，验证没问题后同步到测试环境以及线上环境。
#### 配置的校验
支持对字段值进行唯一性校验等，能避免重复配置、减少错误配置的发送。
#### 自定义审核流程
支持自定义审核流程，每一个审核流程可单独配置审核人。
#### 快速回滚
支持快速回滚配置。
#### 业务校验
支持自定义RPC接口，实现对配置值的校验，只有校验通过后才能走到审核流程。

## 接入思路
### 思路一
让Lion中的每一个业务配置都对应海马平台的一个运营位。如图：  
**优点：**
1. 对于业务来说添加配置比较友好；
**缺点：**
2. 若有新开仓，需要在多个配置中都加入该仓库，并添加审核人。审核时也需要逐个配置进行审核，很麻烦

### 思路二
根据配置的key不同，可以划分为城市、运输组、仓库、门店几个维度。我们为每一个维度的审核配置新建一个运营位。

对于每一个运营位，外层字段存储维度数据、内层存储对应的配置项。由于运营位是双层结构，因此我们将审核人设置为列表形式/单行文本。

**优点：**
1. 若有新开仓，则在该运营位中新增一个仓库即可；
2. 审核时只需要在运营位进行，批量审核即可。

**缺点：**
1. 若配置较多，则读取配置时反序列化可能有性能问题；
2. 配置过多，写转换类有点麻烦。由于每个运营位是对应一个响应，因此需要实现由响应到多个配置项的转换映射。

### 进阶思路【统一封装，通过注解实现直接用变量拿到配置】
1. 实现通用注解：`@HaimaConfig(sceneKey = "xxx_xxx", convertor = xxConvertor)`；
2. 提供常见转换类；

后续的配置添加只需要与Lion类似即可。在Config类中添加静态变量，通过注解标识。

### Lion配置的批量迁移
> Lion平台提供批量导出配置功能，海马平台提供导入功能。

对应每一个配置，我们都新建一个运营位。
1. 批量导出Lion配置，通过脚本将其中的配置都生成一个对应的Excel；
2. 新建运营位，运营位sceneKey与Lion中的key设置一致，将对应的配置Excel导入；
3. 数据比对校验。

![[Pasted image 20250806144631.png]]

![[Pasted image 20250815005917.png]]