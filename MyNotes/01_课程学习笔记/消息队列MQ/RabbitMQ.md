## MQ基础
### WorkQueue任务模型
**多个消费者绑定到一个队列中**，共同消费队列中的消息。

生产者生产消息的速度远大于消息的消费速度时，此时会导致**消息堆积**，无法及时处理。此时可以采用Work模型，让多个消费者共同处理消息，提供消费速度。

## 交换机
#### 是什么？
交换机充当路由器角色，一方面接收生产者发送的消息；另一方面，根据路由规则将消息发送给不同的队列。
> 注意：交换机只负责转发消息，不具备存储消息的能力。因此，若无队列与交换机绑定，则可能导致消息丢失。

**带交换机的订阅模型**
![[Pasted image 20250309224129.png|600]]
`publisher`：生产者，发送消息给交换机。
`exchange`：交换机，接收生产者发送的消息，并转发到各个队列中。
`queue`：消息队列，用于接收、缓存消息，需要与交换机绑定。
`consumer`：消费者，订阅队列，消费队列中的消息。
#### 交换机类型
有四种常见类型：
1. `Fanout`：广播，将消息转发给**所有绑定的队列**。
2. `Direct`：订阅，基于路由Key（RoutingKey）将消息发送给订阅的队列。
3. `Topic`：通配符订阅，与Direct类似，不过RoutingKey可以使用通配符。
4. `Headers`：头匹配，基于MQ消息的头匹配。
##### Direct模式
- 生产者发送消息给交换机时，需要指定RoutingKey；
- 队列与交换机绑定时，需要指定RoutingKey；
- 交换机转发消息时，根据消息的RoutingKey进行判断，只有队列的RoutingKey与消息的RoutingKey完全一致，才会进行转发。

##### Topic模式
在Direct的基础上，RoutingKey可以使用通配符。
通配符规则：
1. \#：匹配一个或多个词；例如`item.#`可以匹配`item.spu.insert`或`item.spu`
2. \*：匹配正好一个词。只能匹配`item.spu`

## MQ高级
### 可能的丢失场景：
发送消息时的丢失：
1. 连接MQ失败；
2. 未找到Exchange；
3. 未找到合适的Queue；
4. 到达MQ后，处理消息的进程出现异常。

MQ导致消息丢失：
- 消息到队列中，但尚未消费就宕机。

处理消息时的丢失：
1. 接收后尚未处理突然宕机；
2. 处理过程中出现异常。
### 发送者的可靠性
#### 方案一：生产者的重试机制
发送消息失败时，每隔一定时间进行重试。

#### 方案二：生产者的确认机制
MQ根据消息的处理情况返回不同的绘制给生产者。

### MQ的可靠性
#### 方案一：数据持久化
默认情况下，MQ的数据都是存储在内存中，重启后就会消失。因此需要配置数据持久化：
交换机持久化、队列持久化、消息持久化。

#### 方案二：LazyQueue
默认情况下，MQ会将消息存储在内存中。但若发生消息积压问题，则MQ会将消息刷到磁盘中，称为`PageOut`。`PageOut`会阻塞队列进程，并且此时MQ不再处理新的请求，所有请求都会被阻塞。

为了解决此问题，MQ增加了LazyQueues模式，也就是惰性队列：
- 接收到消息后直接存入磁盘而非内存；
- 懒加载：需要消费时才从磁盘中读取并加载到内存；
- 支持数百万的消息存储。

### 消费者的可靠性
#### 方案一：消费者确认机制
 消费者处理消息结束后，向MQ发送回执，告知消息处理状态，如ack成功处理、nack处理失败、reject处理失败并拒绝。

#### 方案二：失败重试机制
消费者出现异常后，消息会重新入队，再重新发送给消费者，直到处理成功。

#### 方案三：失败处理策略
MQ允许我们自定义在重试次数耗尽后的消息处理策略，有以下三种：
1. `RejectAndDontRequeueRecoverer`：重试耗尽后，直接reject，丢弃消息。【默认方式】
2. `ImmediateRequeueMessageRecoverer`：重试耗尽后，返回nack，消息重新入队。
3. `RepublishMessageRecoverer`：重试耗尽后，将失败消息投递到指定的的交换机，后续可以进行人为处理。

#### 方案四：业务幂等性
可以通过幂等号（如唯一消息ID）、或是通过业务状态（状态机）实现幂等，避免消息重复消费带来的业务问题。

#### 方案五：兜底方案
例如我们在订单交易时，我们常常通过MQ消息来通知交易服务已支付成功，交易服务收到已支付成功的消息后会将更新订单状态。

但若MQ消息通知失败，我们也可以主动查询支付服务来判断支付状态，并根据所查询的支付状态决定是否要更新订单状态。

常见的查询方案主要是通过**定时任务**定期查询。