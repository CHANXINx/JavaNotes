>【[vivo优惠券系统架构设计与实践 | ReturnAC](https://returnac.cn/pages/Knowledge/scheme/vivo%E5%85%A8%E7%90%83%E5%95%86%E5%9F%8E-%E4%BC%98%E6%83%A0%E5%88%B8%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5.html#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1)】

# 系统架构
![[Pasted image 20241219002916.png|600]]
# 功能提供
## 优惠券发放设计
### 统一领券
#### **①存在的问题：保证领券校验的准确性**
- **资格校验**：库存限制、限领数量是需要校验的关键参数，避免超发与用户超领问题。

**解决方案：**
- **采用分布式锁**：资格校验前先获取锁，然后开启事务；优惠券发放成功后或资格校验失败后，结束事务，释放锁。

#### ②库存扣减：保证并发性能以及一致性
库存扣减有两种方案：
- 方案一：数据库扣减。
	- **优点**：简单便捷，无一致性问题。
	- **缺点**：1）库存是数据库中的单个字段，更新库存时，所有请求都需等待行锁释放。若并发量大，会导致请求阻塞，连接超时，造成系统雪崩；2）频繁连接数据库，会占用大量数据库连接资源。
- 方案二：Redis扣减。高性能，抗并发，但是会引入数据不一致问题。
- 方案三：从优惠券系统当前及可预见未来的**流量峰值、系统维护性、实用性**上综合考虑，优惠券系统采用了方案一的改进方案：
	- 将单库存字段分散成多库存字段，分散数据库的行锁，减少并发量大时数据库的行锁瓶颈。
	  ![[Pasted image 20241219005757.png|500]]
	- 库存更新后，会将库存平均分配为M份，初始化更新到库存记录表中。用户领券，随机选取库存记录表中的已分配的某一库存字段进行更新。同时，定时任务会定时扫表，定期同步已领取的库存数。

#### ④一次领取多张券（不同券模板）

### 兑换码兑换

### 定向发放
