### 事务消息
RocketMQ的事务消息指的是将消息的发送分为两步，使得本地事务的执行与消息的发送以原子性的方式执行，确保要么同时成功、要么同时失败。：
- 发送半消息，半消息发送成功之后执行本地事务；本地事务执行成功之后，再发送第二个半消息。

存在三种可能出错的情况：
1. 第一个半消息发送失败：此时本地事务不会执行。
2. 本地事务执行失败：此时MQ不会消费。
3. 第二个半消息发送失败：此时本地事务执行成功，MQ会反查执行结果来判断是COMMIT还是ROLLBACK.

>**为什么不先执行本地事务，再发送消息呢？**
>因为假设本地事务执行成功，而第一条半消息发送失败，那么就会导致数据不一致了。
#### 如何实现的？
1. 先发送半消息（预提交），此时消息存储Broker中，状态为"prepared"，还不对消费者可见，无法消费；
2. Broker会返回收到消息后，会返回"预提交"执行结果给发送方，即第一个半消息是否发送成功；
3. 第一个半消息发送成功后，本地事务开始执行，执行结束后，会发送第二个半消息给Broker；
4. 若第二个半消息发送成功，则根据消息类型为
	1. "COMMIT"，则提交事务，此时消息接收方可以开始消费。
	2. "ROLLBACK"，则回滚事务，此时会将消息从Broker中删除，保证消息不被消费。
5. 若Broker未收到发送方发来的第二个半消息，则会向发送方发送检查请求，根据返回的消息判断是需要提交还是回滚事务。若在规定时间内未接收到发送方返回的响应，则会将消息标记为"KNOWN"状态。并且此时会进行带过期时间的等待，若超过过期时间，则会自动回滚、删除事务消息，避免被消费。
![[Pasted image 20250311203501.png]]